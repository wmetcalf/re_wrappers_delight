<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>regex._regex_core &mdash; pyre2 0.3.6.2.dev2+gd971d80 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=c389eeca"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            pyre2
          </a>
              <div class="version">
                0.3
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">pyre2: Python RE2 wrapper for linear-time regular expressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">src</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CHANGELOG.html">Changelog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pyre2</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">regex._regex_core</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for regex._regex_core</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Secret Labs&#39; Regular Expression Engine core module</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 1998-2001 by Secret Labs AB.  All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># This version of the SRE library can be redistributed under CNRI&#39;s</span>
<span class="c1"># Python 1.6 license.  For any other use, please contact Secret Labs</span>
<span class="c1"># AB (info@pythonware.com).</span>
<span class="c1">#</span>
<span class="c1"># Portions of this engine have been developed in cooperation with</span>
<span class="c1"># CNRI.  Hewlett-Packard provided funding for 1.6 integration and</span>
<span class="c1"># other compatibility work.</span>
<span class="c1">#</span>
<span class="c1"># 2010-01-16 mrab Python front-end re-written and extended</span>

<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">unicodedata</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="kn">import</span> <span class="nn">regex._regex</span> <span class="k">as</span> <span class="nn">_regex</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;ASCII&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;BESTMATCH&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="s2">&quot;ENHANCEMATCH&quot;</span><span class="p">,</span>
  <span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;FULLCASE&quot;</span><span class="p">,</span> <span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="s2">&quot;IGNORECASE&quot;</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="s2">&quot;LOCALE&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;MULTILINE&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span>
  <span class="s2">&quot;POSIX&quot;</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;REVERSE&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;DOTALL&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;TEMPLATE&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;UNICODE&quot;</span><span class="p">,</span>
  <span class="s2">&quot;V0&quot;</span><span class="p">,</span> <span class="s2">&quot;VERSION0&quot;</span><span class="p">,</span> <span class="s2">&quot;V1&quot;</span><span class="p">,</span> <span class="s2">&quot;VERSION1&quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="s2">&quot;WORD&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;VERBOSE&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
  <span class="s2">&quot;Scanner&quot;</span><span class="p">,</span> <span class="s2">&quot;RegexFlag&quot;</span><span class="p">]</span>

<span class="c1"># The regex exception.</span>
<div class="viewcode-block" id="error">
<a class="viewcode-back" href="../../api/re2.html#re2.error">[docs]</a>
<span class="k">class</span> <span class="nc">error</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception raised for invalid regular expressions.</span>

<span class="sd">    Attributes:</span>

<span class="sd">        msg: The unformatted error message</span>
<span class="sd">        pattern: The regular expression pattern</span>
<span class="sd">        pos: The position in the pattern where compilation failed, or None</span>
<span class="sd">        lineno: The line number where compilation failed, unless pos is None</span>
<span class="sd">        colno: The column number where compilation failed, unless pos is None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">newline</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="k">if</span> <span class="n">pattern</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lineno</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">newline</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colno</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">pattern</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="n">newline</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> at position </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">newline</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot; (line </span><span class="si">{}</span><span class="s2">, column </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">colno</span><span class="p">)</span>

        <span class="ne">Exception</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span></div>


<span class="c1"># The exception for when a positional flag has been turned on in the old</span>
<span class="c1"># behaviour.</span>
<span class="k">class</span> <span class="nc">_UnscopedFlagSet</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c1"># The exception for when parsing fails and we want to try something else.</span>
<span class="k">class</span> <span class="nc">ParseError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c1"># The exception for when there isn&#39;t a valid first set.</span>
<span class="k">class</span> <span class="nc">_FirstSetError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c1"># Flags.</span>
<span class="k">class</span> <span class="nc">RegexFlag</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntFlag</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">ASCII</span> <span class="o">=</span> <span class="mh">0x80</span>          <span class="c1"># Assume ASCII locale.</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">BESTMATCH</span> <span class="o">=</span> <span class="mh">0x1000</span>    <span class="c1"># Best fuzzy match.</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">DEBUG</span> <span class="o">=</span> <span class="mh">0x200</span>         <span class="c1"># Print parsed pattern.</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">ENHANCEMATCH</span> <span class="o">=</span> <span class="mh">0x8000</span> <span class="c1"># Attempt to improve the fit after finding the first</span>
                              <span class="c1"># fuzzy match.</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">FULLCASE</span> <span class="o">=</span> <span class="mh">0x4000</span>     <span class="c1"># Unicode full case-folding.</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">IGNORECASE</span> <span class="o">=</span> <span class="mh">0x2</span>      <span class="c1"># Ignore case.</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">LOCALE</span> <span class="o">=</span> <span class="mh">0x4</span>          <span class="c1"># Assume current 8-bit locale.</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">MULTILINE</span> <span class="o">=</span> <span class="mh">0x8</span>       <span class="c1"># Make anchors look for newline.</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">POSIX</span> <span class="o">=</span> <span class="mh">0x10000</span>       <span class="c1"># POSIX-style matching (leftmost longest).</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">REVERSE</span> <span class="o">=</span> <span class="mh">0x400</span>       <span class="c1"># Search backwards.</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">DOTALL</span> <span class="o">=</span> <span class="mh">0x10</span>         <span class="c1"># Make dot match newline.</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">UNICODE</span> <span class="o">=</span> <span class="mh">0x20</span>        <span class="c1"># Assume Unicode locale.</span>
    <span class="n">V0</span> <span class="o">=</span> <span class="n">VERSION0</span> <span class="o">=</span> <span class="mh">0x2000</span>    <span class="c1"># Old legacy behaviour.</span>
    <span class="n">V1</span> <span class="o">=</span> <span class="n">VERSION1</span> <span class="o">=</span> <span class="mh">0x100</span>     <span class="c1"># New enhanced behaviour.</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">WORD</span> <span class="o">=</span> <span class="mh">0x800</span>          <span class="c1"># Default Unicode word breaks.</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">VERBOSE</span> <span class="o">=</span> <span class="mh">0x40</span>        <span class="c1"># Ignore whitespace and comments.</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">TEMPLATE</span> <span class="o">=</span> <span class="mh">0x1</span>        <span class="c1"># Template (present because re module has it).</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;regex.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_</span>

        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value_</span>
        <span class="n">members</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">negative</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">negative</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="o">~</span><span class="n">value</span>

        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="n">m</span><span class="o">.</span><span class="n">_value_</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">m</span><span class="o">.</span><span class="n">_value_</span>
                <span class="n">members</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;regex.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">m</span><span class="o">.</span><span class="n">_name_</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">members</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

        <span class="n">res</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">members</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">negative</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">members</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="s1">&#39;~(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">res</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="s1">&#39;~</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">res</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="fm">__str__</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__str__</span>

<span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">RegexFlag</span><span class="o">.</span><span class="n">__members__</span><span class="p">)</span>

<span class="n">DEFAULT_VERSION</span> <span class="o">=</span> <span class="n">VERSION1</span>

<span class="n">_ALL_VERSIONS</span> <span class="o">=</span> <span class="n">VERSION0</span> <span class="o">|</span> <span class="n">VERSION1</span>
<span class="n">_ALL_ENCODINGS</span> <span class="o">=</span> <span class="n">ASCII</span> <span class="o">|</span> <span class="n">LOCALE</span> <span class="o">|</span> <span class="n">UNICODE</span>

<span class="c1"># The default flags for the various versions.</span>
<span class="n">DEFAULT_FLAGS</span> <span class="o">=</span> <span class="p">{</span><span class="n">VERSION0</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VERSION1</span><span class="p">:</span> <span class="n">FULLCASE</span><span class="p">}</span>

<span class="c1"># The mask for the flags.</span>
<span class="n">GLOBAL_FLAGS</span> <span class="o">=</span> <span class="p">(</span><span class="n">_ALL_VERSIONS</span> <span class="o">|</span> <span class="n">BESTMATCH</span> <span class="o">|</span> <span class="n">DEBUG</span> <span class="o">|</span> <span class="n">ENHANCEMATCH</span> <span class="o">|</span> <span class="n">POSIX</span> <span class="o">|</span>
  <span class="n">REVERSE</span><span class="p">)</span>
<span class="n">SCOPED_FLAGS</span> <span class="o">=</span> <span class="p">(</span><span class="n">FULLCASE</span> <span class="o">|</span> <span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">MULTILINE</span> <span class="o">|</span> <span class="n">DOTALL</span> <span class="o">|</span> <span class="n">WORD</span> <span class="o">|</span> <span class="n">VERBOSE</span> <span class="o">|</span>
  <span class="n">_ALL_ENCODINGS</span><span class="p">)</span>

<span class="n">ALPHA</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">)</span>
<span class="n">DIGITS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span>
<span class="n">ALNUM</span> <span class="o">=</span> <span class="n">ALPHA</span> <span class="o">|</span> <span class="n">DIGITS</span>
<span class="n">OCT_DIGITS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">octdigits</span><span class="p">)</span>
<span class="n">HEX_DIGITS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">hexdigits</span><span class="p">)</span>
<span class="n">SPECIAL_CHARS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="s2">&quot;()|?*+{^$.[</span><span class="se">\\</span><span class="s2">#&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="p">])</span>
<span class="n">NAMED_CHAR_PART</span> <span class="o">=</span> <span class="n">ALNUM</span> <span class="o">|</span> <span class="nb">frozenset</span><span class="p">(</span><span class="s2">&quot; -&quot;</span><span class="p">)</span>
<span class="n">PROPERTY_NAME_PART</span> <span class="o">=</span> <span class="n">ALNUM</span> <span class="o">|</span> <span class="nb">frozenset</span><span class="p">(</span><span class="s2">&quot; &amp;_-.&quot;</span><span class="p">)</span>
<span class="n">SET_OPS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;||&quot;</span><span class="p">,</span> <span class="s2">&quot;~~&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;&amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">)</span>

<span class="c1"># The width of the code words inside the regex engine.</span>
<span class="n">BYTES_PER_CODE</span> <span class="o">=</span> <span class="n">_regex</span><span class="o">.</span><span class="n">get_code_size</span><span class="p">()</span>
<span class="n">BITS_PER_CODE</span> <span class="o">=</span> <span class="n">BYTES_PER_CODE</span> <span class="o">*</span> <span class="mi">8</span>

<span class="c1"># The repeat count which represents infinity.</span>
<span class="n">UNLIMITED</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BITS_PER_CODE</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

<span class="c1"># The regular expression flags.</span>
<span class="n">REGEX_FLAGS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="n">ASCII</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="n">BESTMATCH</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="n">ENHANCEMATCH</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">:</span> <span class="n">FULLCASE</span><span class="p">,</span>
  <span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="n">IGNORECASE</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="n">LOCALE</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">:</span> <span class="n">MULTILINE</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">:</span> <span class="n">POSIX</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="n">REVERSE</span><span class="p">,</span>
  <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="n">DOTALL</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="n">UNICODE</span><span class="p">,</span> <span class="s2">&quot;V0&quot;</span><span class="p">:</span> <span class="n">VERSION0</span><span class="p">,</span> <span class="s2">&quot;V1&quot;</span><span class="p">:</span> <span class="n">VERSION1</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">:</span> <span class="n">WORD</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
  <span class="n">VERBOSE</span><span class="p">}</span>

<span class="c1"># The case flags.</span>
<span class="n">CASE_FLAGS</span> <span class="o">=</span> <span class="n">FULLCASE</span> <span class="o">|</span> <span class="n">IGNORECASE</span>
<span class="n">NOCASE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">FULLIGNORECASE</span> <span class="o">=</span> <span class="n">FULLCASE</span> <span class="o">|</span> <span class="n">IGNORECASE</span>

<span class="n">FULL_CASE_FOLDING</span> <span class="o">=</span> <span class="n">UNICODE</span> <span class="o">|</span> <span class="n">FULLIGNORECASE</span>

<span class="n">CASE_FLAGS_COMBINATIONS</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FULLCASE</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IGNORECASE</span><span class="p">:</span> <span class="n">IGNORECASE</span><span class="p">,</span>
  <span class="n">FULLIGNORECASE</span><span class="p">:</span> <span class="n">FULLIGNORECASE</span><span class="p">}</span>

<span class="c1"># The number of digits in hexadecimal escapes.</span>
<span class="n">HEX_ESCAPES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>

<span class="c1"># The names of the opcodes.</span>
<span class="n">OPCODES</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">FAILURE</span>
<span class="s2">SUCCESS</span>
<span class="s2">ANY</span>
<span class="s2">ANY_ALL</span>
<span class="s2">ANY_ALL_REV</span>
<span class="s2">ANY_REV</span>
<span class="s2">ANY_U</span>
<span class="s2">ANY_U_REV</span>
<span class="s2">ATOMIC</span>
<span class="s2">BOUNDARY</span>
<span class="s2">BRANCH</span>
<span class="s2">CALL_REF</span>
<span class="s2">CHARACTER</span>
<span class="s2">CHARACTER_IGN</span>
<span class="s2">CHARACTER_IGN_REV</span>
<span class="s2">CHARACTER_REV</span>
<span class="s2">CONDITIONAL</span>
<span class="s2">DEFAULT_BOUNDARY</span>
<span class="s2">DEFAULT_END_OF_WORD</span>
<span class="s2">DEFAULT_START_OF_WORD</span>
<span class="s2">END</span>
<span class="s2">END_OF_LINE</span>
<span class="s2">END_OF_LINE_U</span>
<span class="s2">END_OF_STRING</span>
<span class="s2">END_OF_STRING_LINE</span>
<span class="s2">END_OF_STRING_LINE_U</span>
<span class="s2">END_OF_WORD</span>
<span class="s2">FUZZY</span>
<span class="s2">GRAPHEME_BOUNDARY</span>
<span class="s2">GREEDY_REPEAT</span>
<span class="s2">GROUP</span>
<span class="s2">GROUP_CALL</span>
<span class="s2">GROUP_EXISTS</span>
<span class="s2">KEEP</span>
<span class="s2">LAZY_REPEAT</span>
<span class="s2">LOOKAROUND</span>
<span class="s2">NEXT</span>
<span class="s2">PROPERTY</span>
<span class="s2">PROPERTY_IGN</span>
<span class="s2">PROPERTY_IGN_REV</span>
<span class="s2">PROPERTY_REV</span>
<span class="s2">PRUNE</span>
<span class="s2">RANGE</span>
<span class="s2">RANGE_IGN</span>
<span class="s2">RANGE_IGN_REV</span>
<span class="s2">RANGE_REV</span>
<span class="s2">REF_GROUP</span>
<span class="s2">REF_GROUP_FLD</span>
<span class="s2">REF_GROUP_FLD_REV</span>
<span class="s2">REF_GROUP_IGN</span>
<span class="s2">REF_GROUP_IGN_REV</span>
<span class="s2">REF_GROUP_REV</span>
<span class="s2">SEARCH_ANCHOR</span>
<span class="s2">SET_DIFF</span>
<span class="s2">SET_DIFF_IGN</span>
<span class="s2">SET_DIFF_IGN_REV</span>
<span class="s2">SET_DIFF_REV</span>
<span class="s2">SET_INTER</span>
<span class="s2">SET_INTER_IGN</span>
<span class="s2">SET_INTER_IGN_REV</span>
<span class="s2">SET_INTER_REV</span>
<span class="s2">SET_SYM_DIFF</span>
<span class="s2">SET_SYM_DIFF_IGN</span>
<span class="s2">SET_SYM_DIFF_IGN_REV</span>
<span class="s2">SET_SYM_DIFF_REV</span>
<span class="s2">SET_UNION</span>
<span class="s2">SET_UNION_IGN</span>
<span class="s2">SET_UNION_IGN_REV</span>
<span class="s2">SET_UNION_REV</span>
<span class="s2">SKIP</span>
<span class="s2">START_OF_LINE</span>
<span class="s2">START_OF_LINE_U</span>
<span class="s2">START_OF_STRING</span>
<span class="s2">START_OF_WORD</span>
<span class="s2">STRING</span>
<span class="s2">STRING_FLD</span>
<span class="s2">STRING_FLD_REV</span>
<span class="s2">STRING_IGN</span>
<span class="s2">STRING_IGN_REV</span>
<span class="s2">STRING_REV</span>
<span class="s2">FUZZY_EXT</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># Define the opcodes in a namespace.</span>
<span class="k">class</span> <span class="nc">Namespace</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="n">OP</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OPCODES</span><span class="o">.</span><span class="n">split</span><span class="p">()):</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">OP</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_shrink_cache</span><span class="p">(</span><span class="n">cache_dict</span><span class="p">,</span> <span class="n">args_dict</span><span class="p">,</span> <span class="n">locale_sensitive</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">divisor</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make room in the given cache.</span>

<span class="sd">    Args:</span>
<span class="sd">        cache_dict: The cache dictionary to modify.</span>
<span class="sd">        args_dict: The dictionary of named list args used by patterns.</span>
<span class="sd">        max_length: Maximum # of entries in cache_dict before it is shrunk.</span>
<span class="sd">        divisor: Cache will shrink to max_length - 1/divisor*max_length items.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Toss out a fraction of the entries at random to make room for new ones.</span>
    <span class="c1"># A random algorithm was chosen as opposed to simply cache_dict.popitem()</span>
    <span class="c1"># as popitem could penalize the same regular expression repeatedly based</span>
    <span class="c1"># on its internal hash value.  Being random should spread the cache miss</span>
    <span class="c1"># love around.</span>
    <span class="n">cache_keys</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">cache_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">overage</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cache_keys</span><span class="p">)</span> <span class="o">-</span> <span class="n">max_length</span>
    <span class="k">if</span> <span class="n">overage</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Cache is already within limits.  Normally this should not happen</span>
        <span class="c1"># but it could due to multithreading.</span>
        <span class="k">return</span>

    <span class="n">number_to_toss</span> <span class="o">=</span> <span class="n">max_length</span> <span class="o">//</span> <span class="n">divisor</span> <span class="o">+</span> <span class="n">overage</span>

    <span class="c1"># The import is done here to avoid a circular dependency.</span>
    <span class="kn">import</span> <span class="nn">random</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">random</span><span class="p">,</span> <span class="s1">&#39;sample&#39;</span><span class="p">):</span>
        <span class="c1"># Do nothing while resolving the circular dependency:</span>
        <span class="c1">#  re-&gt;random-&gt;warnings-&gt;tokenize-&gt;string-&gt;re</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">doomed_key</span> <span class="ow">in</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">cache_keys</span><span class="p">,</span> <span class="n">number_to_toss</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">cache_dict</span><span class="p">[</span><span class="n">doomed_key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># Ignore problems if the cache changed from another thread.</span>
            <span class="k">pass</span>

    <span class="c1"># Rebuild the arguments and locale-sensitivity dictionaries.</span>
    <span class="n">args_dict</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">sensitivity_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">pattern_type</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">default_version</span><span class="p">,</span> <span class="n">locale</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">cache_dict</span><span class="p">):</span>
        <span class="n">args_dict</span><span class="p">[</span><span class="n">pattern</span><span class="p">,</span> <span class="n">pattern_type</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">default_version</span><span class="p">,</span> <span class="n">locale</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sensitivity_dict</span><span class="p">[</span><span class="n">pattern_type</span><span class="p">,</span> <span class="n">pattern</span><span class="p">]</span> <span class="o">=</span> <span class="n">locale_sensitive</span><span class="p">[</span><span class="n">pattern_type</span><span class="p">,</span> <span class="n">pattern</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">locale_sensitive</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">locale_sensitive</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sensitivity_dict</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_fold_case</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
    <span class="s2">&quot;Folds the case of a string.&quot;</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">_ALL_ENCODINGS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="n">info</span><span class="o">.</span><span class="n">guess_encoding</span>

    <span class="k">return</span> <span class="n">_regex</span><span class="o">.</span><span class="n">fold_case</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">is_cased_i</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">char</span><span class="p">):</span>
    <span class="s2">&quot;Checks whether a character is cased.&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">_regex</span><span class="o">.</span><span class="n">get_all_cases</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span><span class="p">,</span> <span class="n">char</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">is_cased_f</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">char</span><span class="p">):</span>
    <span class="s2">&quot;Checks whether a character is cased.&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">_regex</span><span class="o">.</span><span class="n">get_all_cases</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">char</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">_compile_firstset</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">fs</span><span class="p">):</span>
    <span class="s2">&quot;Compiles the firstset for the pattern.&quot;</span>
    <span class="n">reverse</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REVERSE</span><span class="p">)</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">_check_firstset</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fs</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fs</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># Compile the firstset.</span>
    <span class="k">return</span> <span class="n">fs</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">reverse</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_check_firstset</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fs</span><span class="p">):</span>
    <span class="s2">&quot;Checks the firstset for the pattern.&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fs</span> <span class="ow">or</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">fs</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># If we ignore the case, for simplicity we won&#39;t build a firstset.</span>
    <span class="n">members</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">case_flags</span> <span class="o">=</span> <span class="n">NOCASE</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fs</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Character</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">positive</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

<span class="c1">#        if i.case_flags:</span>
<span class="c1">#            if isinstance(i, Character):</span>
<span class="c1">#                if is_cased_i(info, i.value):</span>
<span class="c1">#                    return []</span>
<span class="c1">#            elif isinstance(i, SetBase):</span>
<span class="c1">#                return []</span>
        <span class="n">case_flags</span> <span class="o">|=</span> <span class="n">i</span><span class="o">.</span><span class="n">case_flags</span>
        <span class="n">members</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">with_flags</span><span class="p">(</span><span class="n">case_flags</span><span class="o">=</span><span class="n">NOCASE</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">case_flags</span> <span class="o">==</span> <span class="p">(</span><span class="n">FULLCASE</span> <span class="o">|</span> <span class="n">IGNORECASE</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Build the firstset.</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">SetUnion</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">members</span><span class="p">),</span> <span class="n">case_flags</span><span class="o">=</span><span class="n">case_flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FULLCASE</span><span class="p">,</span>
      <span class="n">zerowidth</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">in_set</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fs</span>

<span class="k">def</span> <span class="nf">_flatten_code</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
    <span class="s2">&quot;Flattens the code from a list of tuples.&quot;</span>
    <span class="n">flat_code</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
        <span class="n">flat_code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">flat_code</span>

<span class="k">def</span> <span class="nf">make_case_flags</span><span class="p">(</span><span class="n">info</span><span class="p">):</span>
    <span class="s2">&quot;Makes the case flags.&quot;</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CASE_FLAGS</span>

    <span class="c1"># Turn off FULLCASE if ASCII is turned on.</span>
    <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASCII</span><span class="p">:</span>
        <span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FULLCASE</span>

    <span class="k">return</span> <span class="n">flags</span>

<span class="k">def</span> <span class="nf">make_character</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">in_set</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="s2">&quot;Makes a character literal.&quot;</span>
    <span class="k">if</span> <span class="n">in_set</span><span class="p">:</span>
        <span class="c1"># A character set is built case-sensitively.</span>
        <span class="k">return</span> <span class="n">Character</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Character</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">case_flags</span><span class="o">=</span><span class="n">make_case_flags</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">make_ref_group</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
    <span class="s2">&quot;Makes a group reference.&quot;</span>
    <span class="k">return</span> <span class="n">RefGroup</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">case_flags</span><span class="o">=</span><span class="n">make_case_flags</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">make_string_set</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="s2">&quot;Makes a string set.&quot;</span>
    <span class="k">return</span> <span class="n">StringSet</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">case_flags</span><span class="o">=</span><span class="n">make_case_flags</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">make_property</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">in_set</span><span class="p">):</span>
    <span class="s2">&quot;Makes a property.&quot;</span>
    <span class="k">if</span> <span class="n">in_set</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">prop</span>

    <span class="k">return</span> <span class="n">prop</span><span class="o">.</span><span class="n">with_flags</span><span class="p">(</span><span class="n">case_flags</span><span class="o">=</span><span class="n">make_case_flags</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_parse_pattern</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="s2">&quot;Parses a pattern, eg. &#39;a|b|c&#39;.&quot;</span>
    <span class="n">branches</span> <span class="o">=</span> <span class="p">[</span><span class="n">parse_sequence</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)]</span>
    <span class="k">while</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">):</span>
        <span class="n">branches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse_sequence</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">branches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Branch</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_sequence</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="s2">&quot;Parses a sequence, eg. &#39;abc&#39;.&quot;</span>
    <span class="n">sequence</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
    <span class="n">case_flags</span> <span class="o">=</span> <span class="n">make_case_flags</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">SPECIAL_CHARS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="s2">&quot;)|&quot;</span><span class="p">:</span>
                <span class="c1"># The end of a sequence. At the end of the pattern ch is &quot;&quot;.</span>
                <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="c1"># An escape sequence outside a set.</span>
                <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse_escape</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;(&quot;</span><span class="p">:</span>
                <span class="c1"># A parenthesised subpattern or a flag.</span>
                <span class="n">element</span> <span class="o">=</span> <span class="n">parse_paren</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">case_flags</span> <span class="o">=</span> <span class="n">make_case_flags</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
                <span class="c1"># Any character.</span>
                <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DOTALL</span><span class="p">:</span>
                    <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AnyAll</span><span class="p">())</span>
                <span class="k">elif</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WORD</span><span class="p">:</span>
                    <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AnyU</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Any</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;[&quot;</span><span class="p">:</span>
                <span class="c1"># A character set.</span>
                <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse_set</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;^&quot;</span><span class="p">:</span>
                <span class="c1"># The start of a line or the string.</span>
                <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MULTILINE</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WORD</span><span class="p">:</span>
                        <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">StartOfLineU</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">StartOfLine</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">StartOfString</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;$&quot;</span><span class="p">:</span>
                <span class="c1"># The end of a line or the string.</span>
                <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MULTILINE</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WORD</span><span class="p">:</span>
                        <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EndOfLineU</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EndOfLine</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WORD</span><span class="p">:</span>
                        <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EndOfStringLineU</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EndOfStringLine</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="ow">in</span> <span class="s2">&quot;?*+{&quot;</span><span class="p">:</span>
                <span class="c1"># Looks like a quantifier.</span>
                <span class="n">counts</span> <span class="o">=</span> <span class="n">parse_quantifier</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">counts</span><span class="p">:</span>
                    <span class="c1"># It _is_ a quantifier.</span>
                    <span class="n">apply_quantifier</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span>
                      <span class="n">saved_pos</span><span class="p">,</span> <span class="n">sequence</span><span class="p">)</span>
                    <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># It&#39;s not a quantifier. Maybe it&#39;s a fuzzy constraint.</span>
                    <span class="n">constraints</span> <span class="o">=</span> <span class="n">parse_fuzzy</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">constraints</span><span class="p">:</span>
                        <span class="c1"># It _is_ a fuzzy constraint.</span>
                        <span class="n">apply_constraint</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">,</span>
                          <span class="n">saved_pos</span><span class="p">,</span> <span class="n">sequence</span><span class="p">)</span>
                        <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># The element was just a literal.</span>
                        <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Character</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span>
                          <span class="n">case_flags</span><span class="o">=</span><span class="n">case_flags</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># A literal.</span>
                <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Character</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="n">case_flags</span><span class="o">=</span><span class="n">case_flags</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># A literal.</span>
            <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Character</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="n">case_flags</span><span class="o">=</span><span class="n">case_flags</span><span class="p">))</span>

    <span class="n">sequence</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sequence</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Sequence</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">apply_quantifier</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">saved_pos</span><span class="p">,</span>
  <span class="n">sequence</span><span class="p">):</span>
    <span class="n">element</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sequence</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;multiple repeat&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">saved_pos</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;nothing to repeat&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">saved_pos</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="p">(</span><span class="n">GreedyRepeat</span><span class="p">,</span> <span class="n">LazyRepeat</span><span class="p">,</span> <span class="n">PossessiveRepeat</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;multiple repeat&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">saved_pos</span><span class="p">)</span>

    <span class="n">min_count</span><span class="p">,</span> <span class="n">max_count</span> <span class="o">=</span> <span class="n">counts</span>
    <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;?&quot;</span><span class="p">:</span>
        <span class="c1"># The &quot;?&quot; suffix that means it&#39;s a lazy repeat.</span>
        <span class="n">repeated</span> <span class="o">=</span> <span class="n">LazyRepeat</span>
    <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span>
        <span class="c1"># The &quot;+&quot; suffix that means it&#39;s a possessive repeat.</span>
        <span class="n">repeated</span> <span class="o">=</span> <span class="n">PossessiveRepeat</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No suffix means that it&#39;s a greedy repeat.</span>
        <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>
        <span class="n">repeated</span> <span class="o">=</span> <span class="n">GreedyRepeat</span>

    <span class="c1"># Ignore the quantifier if it applies to a zero-width item or the number of</span>
    <span class="c1"># repeats is fixed at 1.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">element</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">min_count</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">max_count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">repeated</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">min_count</span><span class="p">,</span> <span class="n">max_count</span><span class="p">)</span>

    <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">apply_constraint</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">,</span> <span class="n">saved_pos</span><span class="p">,</span>
  <span class="n">sequence</span><span class="p">):</span>
    <span class="n">element</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;nothing for fuzzy constraint&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">saved_pos</span><span class="p">)</span>

    <span class="c1"># If a group is marked as fuzzy then put all of the fuzzy part in the</span>
    <span class="c1"># group.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Group</span><span class="p">):</span>
        <span class="n">element</span><span class="o">.</span><span class="n">subpattern</span> <span class="o">=</span> <span class="n">Fuzzy</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">subpattern</span><span class="p">,</span> <span class="n">constraints</span><span class="p">)</span>
        <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Fuzzy</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">constraints</span><span class="p">))</span>

<span class="n">_QUANTIFIERS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;?&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;+&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)}</span>

<span class="k">def</span> <span class="nf">parse_quantifier</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">ch</span><span class="p">):</span>
    <span class="s2">&quot;Parses a quantifier.&quot;</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">_QUANTIFIERS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">q</span><span class="p">:</span>
        <span class="c1"># It&#39;s a quantifier.</span>
        <span class="k">return</span> <span class="n">q</span>

    <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;{&quot;</span><span class="p">:</span>
        <span class="c1"># Looks like a limited repeated element, eg. &#39;a{2,3}&#39;.</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">parse_limited_quantifier</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">counts</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">counts</span>

    <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">is_above_limit</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="s2">&quot;Checks whether a count is above the maximum.&quot;</span>
    <span class="k">return</span> <span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="n">UNLIMITED</span>

<span class="k">def</span> <span class="nf">parse_limited_quantifier</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="s2">&quot;Parses a limited quantifier.&quot;</span>
    <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
    <span class="n">min_count</span> <span class="o">=</span> <span class="n">parse_count</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
        <span class="n">max_count</span> <span class="o">=</span> <span class="n">parse_count</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

        <span class="c1"># No minimum means 0 and no maximum means unlimited.</span>
        <span class="n">min_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_count</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">max_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_count</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_count</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">min_count</span><span class="p">:</span>
            <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">min_count</span> <span class="o">=</span> <span class="n">max_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_count</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span> <span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">):</span>
        <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">is_above_limit</span><span class="p">(</span><span class="n">min_count</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_above_limit</span><span class="p">(</span><span class="n">max_count</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;repeat count too big&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">saved_pos</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">max_count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">min_count</span> <span class="o">&gt;</span> <span class="n">max_count</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;min repeat greater than max repeat&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
          <span class="n">saved_pos</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">min_count</span><span class="p">,</span> <span class="n">max_count</span>

<span class="k">def</span> <span class="nf">parse_fuzzy</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">):</span>
    <span class="s2">&quot;Parses a fuzzy setting, if present.&quot;</span>
    <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>

    <span class="k">if</span> <span class="n">ch</span> <span class="o">!=</span> <span class="s2">&quot;{&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">constraints</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">parse_fuzzy_item</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">constraints</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
            <span class="n">parse_fuzzy_item</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">constraints</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ParseError</span><span class="p">:</span>
        <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">):</span>
        <span class="n">constraints</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse_fuzzy_test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;expected }&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">constraints</span>

<span class="k">def</span> <span class="nf">parse_fuzzy_item</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">constraints</span><span class="p">):</span>
    <span class="s2">&quot;Parses a fuzzy setting item.&quot;</span>
    <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">parse_cost_constraint</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">constraints</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ParseError</span><span class="p">:</span>
        <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>

        <span class="n">parse_cost_equation</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">constraints</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_cost_constraint</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">constraints</span><span class="p">):</span>
    <span class="s2">&quot;Parses a cost constraint.&quot;</span>
    <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">ALPHA</span><span class="p">:</span>
        <span class="c1"># Syntax: constraint [(&quot;&lt;=&quot; | &quot;&lt;&quot;) cost]</span>
        <span class="n">constraint</span> <span class="o">=</span> <span class="n">parse_constraint</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>

        <span class="n">max_inc</span> <span class="o">=</span> <span class="n">parse_fuzzy_compare</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">max_inc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># No maximum cost.</span>
            <span class="n">constraints</span><span class="p">[</span><span class="n">constraint</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># There&#39;s a maximum cost.</span>
            <span class="n">cost_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
            <span class="n">max_cost</span> <span class="o">=</span> <span class="n">parse_cost_limit</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

            <span class="c1"># Inclusive or exclusive limit?</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">max_inc</span><span class="p">:</span>
                <span class="n">max_cost</span> <span class="o">-=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">max_cost</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;bad fuzzy cost limit&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">cost_pos</span><span class="p">)</span>

            <span class="n">constraints</span><span class="p">[</span><span class="n">constraint</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_cost</span>
    <span class="k">elif</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">DIGITS</span><span class="p">:</span>
        <span class="c1"># Syntax: cost (&quot;&lt;=&quot; | &quot;&lt;&quot;) constraint (&quot;&lt;=&quot; | &quot;&lt;&quot;) cost</span>
        <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>

        <span class="c1"># Minimum cost.</span>
        <span class="n">cost_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
        <span class="n">min_cost</span> <span class="o">=</span> <span class="n">parse_cost_limit</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

        <span class="n">min_inc</span> <span class="o">=</span> <span class="n">parse_fuzzy_compare</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">min_inc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParseError</span><span class="p">()</span>

        <span class="n">constraint</span> <span class="o">=</span> <span class="n">parse_constraint</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

        <span class="n">max_inc</span> <span class="o">=</span> <span class="n">parse_fuzzy_compare</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_inc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParseError</span><span class="p">()</span>

        <span class="c1"># Maximum cost.</span>
        <span class="n">cost_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
        <span class="n">max_cost</span> <span class="o">=</span> <span class="n">parse_cost_limit</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

        <span class="c1"># Inclusive or exclusive limits?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">min_inc</span><span class="p">:</span>
            <span class="n">min_cost</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">max_inc</span><span class="p">:</span>
            <span class="n">max_cost</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">min_cost</span> <span class="o">&lt;=</span> <span class="n">max_cost</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;bad fuzzy cost limit&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">cost_pos</span><span class="p">)</span>

        <span class="n">constraints</span><span class="p">[</span><span class="n">constraint</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_cost</span><span class="p">,</span> <span class="n">max_cost</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ParseError</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">parse_cost_limit</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="s2">&quot;Parses a cost limit.&quot;</span>
    <span class="n">cost_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
    <span class="n">digits</span> <span class="o">=</span> <span class="n">parse_count</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;bad fuzzy cost limit&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">cost_pos</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_constraint</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">ch</span><span class="p">):</span>
    <span class="s2">&quot;Parses a constraint.&quot;</span>
    <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;deis&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ParseError</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ParseError</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">ch</span>

<span class="k">def</span> <span class="nf">parse_fuzzy_compare</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="s2">&quot;Parses a cost comparator.&quot;</span>
    <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;&lt;=&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">parse_cost_equation</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">constraints</span><span class="p">):</span>
    <span class="s2">&quot;Parses a cost equation.&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;cost&quot;</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;more than one cost equation&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

    <span class="n">cost</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">parse_cost_term</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">):</span>
        <span class="n">parse_cost_term</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span>

    <span class="n">max_inc</span> <span class="o">=</span> <span class="n">parse_fuzzy_compare</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">max_inc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ParseError</span><span class="p">()</span>

    <span class="n">max_cost</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parse_count</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">max_inc</span><span class="p">:</span>
        <span class="n">max_cost</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">max_cost</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;bad fuzzy cost limit&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

    <span class="n">cost</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_cost</span>

    <span class="n">constraints</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cost</span>

<span class="k">def</span> <span class="nf">parse_cost_term</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">cost</span><span class="p">):</span>
    <span class="s2">&quot;Parses a cost equation term.&quot;</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">parse_count</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;dis&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ParseError</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">cost</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;repeated fuzzy cost&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

    <span class="n">cost</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">coeff</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_fuzzy_test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">):</span>
    <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">SPECIAL_CHARS</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">:</span>
            <span class="c1"># An escape sequence outside a set.</span>
            <span class="k">return</span> <span class="n">parse_escape</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
            <span class="c1"># Any character.</span>
            <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DOTALL</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">AnyAll</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WORD</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">AnyU</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Any</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;[&quot;</span><span class="p">:</span>
            <span class="c1"># A character set.</span>
            <span class="k">return</span> <span class="n">parse_set</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;expected character set&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">saved_pos</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ch</span><span class="p">:</span>
        <span class="c1"># A literal.</span>
        <span class="k">return</span> <span class="n">Character</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="n">case_flags</span><span class="o">=</span><span class="n">case_flags</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;expected character set&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">saved_pos</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_count</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="s2">&quot;Parses a quantifier&#39;s count, which can be empty.&quot;</span>
    <span class="k">return</span> <span class="n">source</span><span class="o">.</span><span class="n">get_while</span><span class="p">(</span><span class="n">DIGITS</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_paren</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parses a parenthesised subpattern or a flag. Returns FLAGS if it&#39;s an</span>
<span class="sd">    inline flag.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;?&quot;</span><span class="p">:</span>
        <span class="c1"># (?...</span>
        <span class="n">saved_pos_2</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">:</span>
            <span class="c1"># (?&lt;...</span>
            <span class="n">saved_pos_3</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;!&quot;</span><span class="p">):</span>
                <span class="c1"># (?&lt;=... or (?&lt;!...: lookbehind.</span>
                <span class="k">return</span> <span class="n">parse_lookaround</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;=&quot;</span><span class="p">)</span>

            <span class="c1"># (?&lt;...: a named capture group.</span>
            <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos_3</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">parse_name</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>
            <span class="n">saved_flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">subpattern</span> <span class="o">=</span> <span class="n">_parse_pattern</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
                <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">saved_flags</span>
                <span class="n">source</span><span class="o">.</span><span class="n">ignore_space</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VERBOSE</span><span class="p">)</span>

            <span class="n">info</span><span class="o">.</span><span class="n">close_group</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Group</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">subpattern</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;!&quot;</span><span class="p">):</span>
            <span class="c1"># (?=... or (?!...: lookahead.</span>
            <span class="k">return</span> <span class="n">parse_lookaround</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;=&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;P&quot;</span><span class="p">:</span>
            <span class="c1"># (?P...: a Python extension.</span>
            <span class="k">return</span> <span class="n">parse_extension</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
            <span class="c1"># (?#...: a comment.</span>
            <span class="k">return</span> <span class="n">parse_comment</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;(&quot;</span><span class="p">:</span>
            <span class="c1"># (?(...: a conditional subpattern.</span>
            <span class="k">return</span> <span class="n">parse_conditional</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span>
            <span class="c1"># (?&gt;...: an atomic subpattern.</span>
            <span class="k">return</span> <span class="n">parse_atomic</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;|&quot;</span><span class="p">:</span>
            <span class="c1"># (?|...: a common/reset groups branch.</span>
            <span class="k">return</span> <span class="n">parse_common</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;R&quot;</span> <span class="ow">or</span> <span class="s2">&quot;0&quot;</span> <span class="o">&lt;=</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="s2">&quot;9&quot;</span><span class="p">:</span>
            <span class="c1"># (?R...: probably a call to a group.</span>
            <span class="k">return</span> <span class="n">parse_call_group</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">saved_pos_2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">:</span>
            <span class="c1"># (?&amp;...: a call to a named group.</span>
            <span class="k">return</span> <span class="n">parse_call_named_group</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">saved_pos_2</span><span class="p">)</span>

        <span class="c1"># (?...: probably a flags subpattern.</span>
        <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos_2</span>
        <span class="k">return</span> <span class="n">parse_flags_subpattern</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
        <span class="c1"># (*...</span>
        <span class="n">saved_pos_2</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get_while</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="s2">&quot;)&gt;&quot;</span><span class="p">),</span> <span class="n">include</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">word</span><span class="p">[</span> <span class="p">:</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
            <span class="n">verb</span> <span class="o">=</span> <span class="n">VERBS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">verb</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;unknown verb&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">saved_pos_2</span><span class="p">)</span>

            <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">verb</span>

    <span class="c1"># (...: an unnamed capture group.</span>
    <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">open_group</span><span class="p">()</span>
    <span class="n">saved_flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">subpattern</span> <span class="o">=</span> <span class="n">_parse_pattern</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">saved_flags</span>
        <span class="n">source</span><span class="o">.</span><span class="n">ignore_space</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VERBOSE</span><span class="p">)</span>

    <span class="n">info</span><span class="o">.</span><span class="n">close_group</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">Group</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">subpattern</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_extension</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="s2">&quot;Parses a Python extension.&quot;</span>
    <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">:</span>
        <span class="c1"># (?P&lt;...: a named capture group.</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">parse_name</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>
        <span class="n">saved_flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">subpattern</span> <span class="o">=</span> <span class="n">_parse_pattern</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
            <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">saved_flags</span>
            <span class="n">source</span><span class="o">.</span><span class="n">ignore_space</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VERBOSE</span><span class="p">)</span>

        <span class="n">info</span><span class="o">.</span><span class="n">close_group</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">Group</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">subpattern</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;=&quot;</span><span class="p">:</span>
        <span class="c1"># (?P=...: a named group reference.</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">parse_name</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">allow_numeric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">is_open_group</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;cannot refer to an open group&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
              <span class="n">saved_pos</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">make_ref_group</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">saved_pos</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;&gt;&quot;</span> <span class="ow">or</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">:</span>
        <span class="c1"># (?P&gt;...: a call to a group.</span>
        <span class="k">return</span> <span class="n">parse_call_named_group</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">saved_pos</span><span class="p">)</span>

    <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>
    <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;unknown extension&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">saved_pos</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_comment</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="s2">&quot;Parses a comment.&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;)&quot;</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>
    <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">parse_lookaround</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">behind</span><span class="p">,</span> <span class="n">positive</span><span class="p">):</span>
    <span class="s2">&quot;Parses a lookaround.&quot;</span>
    <span class="n">saved_flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">subpattern</span> <span class="o">=</span> <span class="n">_parse_pattern</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">saved_flags</span>
        <span class="n">source</span><span class="o">.</span><span class="n">ignore_space</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VERBOSE</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">LookAround</span><span class="p">(</span><span class="n">behind</span><span class="p">,</span> <span class="n">positive</span><span class="p">,</span> <span class="n">subpattern</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_conditional</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="s2">&quot;Parses a conditional subpattern.&quot;</span>
    <span class="n">saved_flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span>
    <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;?&quot;</span><span class="p">:</span>
        <span class="c1"># (?(?...</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;!&quot;</span><span class="p">):</span>
            <span class="c1"># (?(?=... or (?(?!...: lookahead conditional.</span>
            <span class="k">return</span> <span class="n">parse_lookaround_conditional</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;=&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">:</span>
            <span class="c1"># (?(?&lt;...</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;!&quot;</span><span class="p">):</span>
                <span class="c1"># (?(?&lt;=... or (?(?&lt;!...: lookbehind conditional.</span>
                <span class="k">return</span> <span class="n">parse_lookaround_conditional</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">ch</span> <span class="o">==</span>
                  <span class="s2">&quot;=&quot;</span><span class="p">)</span>

        <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;expected lookaround conditional&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
          <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

    <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">parse_name</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
        <span class="n">yes_branch</span> <span class="o">=</span> <span class="n">parse_sequence</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">):</span>
            <span class="n">no_branch</span> <span class="o">=</span> <span class="n">parse_sequence</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">no_branch</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">()</span>

        <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">saved_flags</span>
        <span class="n">source</span><span class="o">.</span><span class="n">ignore_space</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VERBOSE</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">yes_branch</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="ow">and</span> <span class="n">no_branch</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">Sequence</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">Conditional</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">yes_branch</span><span class="p">,</span> <span class="n">no_branch</span><span class="p">,</span> <span class="n">saved_pos</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_lookaround_conditional</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">behind</span><span class="p">,</span> <span class="n">positive</span><span class="p">):</span>
    <span class="n">saved_flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">subpattern</span> <span class="o">=</span> <span class="n">_parse_pattern</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">saved_flags</span>
        <span class="n">source</span><span class="o">.</span><span class="n">ignore_space</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VERBOSE</span><span class="p">)</span>

    <span class="n">yes_branch</span> <span class="o">=</span> <span class="n">parse_sequence</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">):</span>
        <span class="n">no_branch</span> <span class="o">=</span> <span class="n">parse_sequence</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">no_branch</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">()</span>

    <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">LookAroundConditional</span><span class="p">(</span><span class="n">behind</span><span class="p">,</span> <span class="n">positive</span><span class="p">,</span> <span class="n">subpattern</span><span class="p">,</span> <span class="n">yes_branch</span><span class="p">,</span>
      <span class="n">no_branch</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_atomic</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="s2">&quot;Parses an atomic subpattern.&quot;</span>
    <span class="n">saved_flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">subpattern</span> <span class="o">=</span> <span class="n">_parse_pattern</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">saved_flags</span>
        <span class="n">source</span><span class="o">.</span><span class="n">ignore_space</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VERBOSE</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Atomic</span><span class="p">(</span><span class="n">subpattern</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_common</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="s2">&quot;Parses a common groups branch.&quot;</span>
    <span class="c1"># Capture group numbers in different branches can reuse the group numbers.</span>
    <span class="n">initial_group_count</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">group_count</span>
    <span class="n">branches</span> <span class="o">=</span> <span class="p">[</span><span class="n">parse_sequence</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)]</span>
    <span class="n">final_group_count</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">group_count</span>
    <span class="k">while</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">):</span>
        <span class="n">info</span><span class="o">.</span><span class="n">group_count</span> <span class="o">=</span> <span class="n">initial_group_count</span>
        <span class="n">branches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse_sequence</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>
        <span class="n">final_group_count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">final_group_count</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">group_count</span><span class="p">)</span>

    <span class="n">info</span><span class="o">.</span><span class="n">group_count</span> <span class="o">=</span> <span class="n">final_group_count</span>
    <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">branches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Branch</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_call_group</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
    <span class="s2">&quot;Parses a call to a group.&quot;</span>
    <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;R&quot;</span><span class="p">:</span>
        <span class="n">group</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">+</span> <span class="n">source</span><span class="o">.</span><span class="n">get_while</span><span class="p">(</span><span class="n">DIGITS</span><span class="p">)</span>

    <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">CallGroup</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_call_named_group</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
    <span class="s2">&quot;Parses a call to a named group.&quot;</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">parse_name</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">CallGroup</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_flag_set</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="s2">&quot;Parses a set of inline flags.&quot;</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;V&quot;</span><span class="p">:</span>
                <span class="n">ch</span> <span class="o">+=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">REGEX_FLAGS</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>

    <span class="k">return</span> <span class="n">flags</span>

<span class="k">def</span> <span class="nf">parse_flags</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="s2">&quot;Parses flags being turned on/off.&quot;</span>
    <span class="n">flags_on</span> <span class="o">=</span> <span class="n">parse_flag_set</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
        <span class="n">flags_off</span> <span class="o">=</span> <span class="n">parse_flag_set</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">flags_off</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;bad inline flags: no flags after &#39;-&#39;&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
              <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flags_off</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">flags_on</span> <span class="o">&amp;</span> <span class="n">LOCALE</span><span class="p">:</span>
        <span class="c1"># Remember that this pattern as an inline locale flag.</span>
        <span class="n">info</span><span class="o">.</span><span class="n">inline_locale</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">flags_on</span><span class="p">,</span> <span class="n">flags_off</span>

<span class="k">def</span> <span class="nf">parse_subpattern</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">flags_on</span><span class="p">,</span> <span class="n">flags_off</span><span class="p">):</span>
    <span class="s2">&quot;Parses a subpattern with scoped flags.&quot;</span>
    <span class="n">saved_flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span>
    <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">|</span> <span class="n">flags_on</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">flags_off</span>
    <span class="n">source</span><span class="o">.</span><span class="n">ignore_space</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VERBOSE</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">subpattern</span> <span class="o">=</span> <span class="n">_parse_pattern</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">saved_flags</span>
        <span class="n">source</span><span class="o">.</span><span class="n">ignore_space</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VERBOSE</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">subpattern</span>

<span class="k">def</span> <span class="nf">parse_flags_subpattern</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parses a flags subpattern. It could be inline flags or a subpattern</span>
<span class="sd">    possibly with local flags. If it&#39;s a subpattern, then that&#39;s returned;</span>
<span class="sd">    if it&#39;s a inline flags, then None is returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flags_on</span><span class="p">,</span> <span class="n">flags_off</span> <span class="o">=</span> <span class="n">parse_flags</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">flags_off</span> <span class="o">&amp;</span> <span class="n">GLOBAL_FLAGS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;bad inline flags: cannot turn off global flag&quot;</span><span class="p">,</span>
          <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">flags_on</span> <span class="o">&amp;</span> <span class="n">flags_off</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;bad inline flags: flag turned on and off&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
          <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

    <span class="c1"># Handle flags which are global in all regex behaviours.</span>
    <span class="n">new_global_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags_on</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">info</span><span class="o">.</span><span class="n">global_flags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GLOBAL_FLAGS</span>
    <span class="k">if</span> <span class="n">new_global_flags</span><span class="p">:</span>
        <span class="n">info</span><span class="o">.</span><span class="n">global_flags</span> <span class="o">|=</span> <span class="n">new_global_flags</span>

        <span class="c1"># A global has been turned on, so reparse the pattern.</span>
        <span class="k">raise</span> <span class="n">_UnscopedFlagSet</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">global_flags</span><span class="p">)</span>

    <span class="c1"># Ensure that from now on we have only scoped flags.</span>
    <span class="n">flags_on</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GLOBAL_FLAGS</span>

    <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">parse_subpattern</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">flags_on</span><span class="p">,</span> <span class="n">flags_off</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">):</span>
        <span class="n">parse_positional_flags</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">flags_on</span><span class="p">,</span> <span class="n">flags_off</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;unknown extension&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_positional_flags</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">flags_on</span><span class="p">,</span> <span class="n">flags_off</span><span class="p">):</span>
    <span class="s2">&quot;Parses positional flags.&quot;</span>
    <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">|</span> <span class="n">flags_on</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">flags_off</span>
    <span class="n">source</span><span class="o">.</span><span class="n">ignore_space</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VERBOSE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_name</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">allow_numeric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allow_group_0</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="s2">&quot;Parses a name.&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get_while</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="s2">&quot;)&gt;&quot;</span><span class="p">),</span> <span class="n">include</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;missing group name&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="n">min_group</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">allow_group_0</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_numeric</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_group</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;bad character in group name&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
              <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">isidentifier</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;bad character in group name&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
              <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">name</span>

<span class="k">def</span> <span class="nf">is_octal</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="s2">&quot;Checks whether a string is octal.&quot;</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">OCT_DIGITS</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">string</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">is_decimal</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="s2">&quot;Checks whether a string is decimal.&quot;</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">DIGITS</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">string</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">is_hexadecimal</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="s2">&quot;Checks whether a string is hexadecimal.&quot;</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">ch</span> <span class="ow">in</span> <span class="n">HEX_DIGITS</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">string</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_escape</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">in_set</span><span class="p">):</span>
    <span class="s2">&quot;Parses an escape sequence.&quot;</span>
    <span class="n">saved_ignore</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">ignore_space</span>
    <span class="n">source</span><span class="o">.</span><span class="n">ignore_space</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">source</span><span class="o">.</span><span class="n">ignore_space</span> <span class="o">=</span> <span class="n">saved_ignore</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ch</span><span class="p">:</span>
        <span class="c1"># A backslash at the end of the pattern.</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;bad escape (end of pattern)&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">HEX_ESCAPES</span><span class="p">:</span>
        <span class="c1"># A hexadecimal escape sequence.</span>
        <span class="k">return</span> <span class="n">parse_hex_escape</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">HEX_ESCAPES</span><span class="p">[</span><span class="n">ch</span><span class="p">],</span> <span class="n">in_set</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;g&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">in_set</span><span class="p">:</span>
        <span class="c1"># A group reference.</span>
        <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parse_group_ref</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">error</span><span class="p">:</span>
            <span class="c1"># Invalid as a group reference, so assume it&#39;s a literal.</span>
            <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>

        <span class="k">return</span> <span class="n">make_character</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="n">in_set</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;G&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">in_set</span><span class="p">:</span>
        <span class="c1"># A search anchor.</span>
        <span class="k">return</span> <span class="n">SearchAnchor</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;L&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">in_set</span><span class="p">:</span>
        <span class="c1"># A string set.</span>
        <span class="k">return</span> <span class="n">parse_string_set</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span>
        <span class="c1"># A named codepoint.</span>
        <span class="k">return</span> <span class="n">parse_named_char</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">in_set</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ch</span> <span class="ow">in</span> <span class="s2">&quot;pP&quot;</span><span class="p">:</span>
        <span class="c1"># A Unicode property, positive or negative.</span>
        <span class="k">return</span> <span class="n">parse_property</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">in_set</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;R&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">in_set</span><span class="p">:</span>
        <span class="c1"># A line ending.</span>
        <span class="n">charset</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">guess_encoding</span> <span class="o">==</span> <span class="n">UNICODE</span><span class="p">:</span>
            <span class="n">charset</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x2028</span><span class="p">,</span> <span class="mh">0x2029</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">Atomic</span><span class="p">(</span><span class="n">Branch</span><span class="p">([</span><span class="n">String</span><span class="p">([</span><span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">]),</span> <span class="n">SetUnion</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">[</span><span class="n">Character</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
          <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">charset</span><span class="p">])]))</span>
    <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">in_set</span><span class="p">:</span>
        <span class="c1"># A grapheme cluster.</span>
        <span class="k">return</span> <span class="n">Grapheme</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">ALPHA</span><span class="p">:</span>
        <span class="c1"># An alphabetic escape sequence.</span>
        <span class="c1"># Positional escapes aren&#39;t allowed inside a character set.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_set</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WORD</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">WORD_POSITION_ESCAPES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">POSITION_ESCAPES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">CHARSET_ESCAPES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">CHARACTER_ESCAPES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Character</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;bad escape </span><span class="se">\\</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ch</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">DIGITS</span><span class="p">:</span>
        <span class="c1"># A numeric escape sequence.</span>
        <span class="k">return</span> <span class="n">parse_numeric_escape</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">in_set</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># A literal.</span>
        <span class="k">return</span> <span class="n">make_character</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="n">in_set</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_numeric_escape</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">in_set</span><span class="p">):</span>
    <span class="s2">&quot;Parses a numeric escape sequence.&quot;</span>
    <span class="k">if</span> <span class="n">in_set</span> <span class="ow">or</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
        <span class="c1"># Octal escape sequence, max 3 digits.</span>
        <span class="k">return</span> <span class="n">parse_octal_escape</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="p">[</span><span class="n">ch</span><span class="p">],</span> <span class="n">in_set</span><span class="p">)</span>

    <span class="c1"># At least 1 digit, so either octal escape or group.</span>
    <span class="n">digits</span> <span class="o">=</span> <span class="n">ch</span>
    <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">DIGITS</span><span class="p">:</span>
        <span class="c1"># At least 2 digits, so either octal escape or group.</span>
        <span class="n">digits</span> <span class="o">+=</span> <span class="n">ch</span>
        <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">is_octal</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">OCT_DIGITS</span><span class="p">:</span>
            <span class="c1"># 3 octal digits, so octal escape sequence.</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">_ALL_ENCODINGS</span>
            <span class="k">if</span> <span class="n">encoding</span> <span class="o">==</span> <span class="n">ASCII</span> <span class="ow">or</span> <span class="n">encoding</span> <span class="o">==</span> <span class="n">LOCALE</span><span class="p">:</span>
                <span class="n">octal_mask</span> <span class="o">=</span> <span class="mh">0xFF</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">octal_mask</span> <span class="o">=</span> <span class="mh">0x1FF</span>

            <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">digits</span> <span class="o">+</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">octal_mask</span>
            <span class="k">return</span> <span class="n">make_character</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="c1"># Group reference.</span>
    <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>
    <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">is_open_group</span><span class="p">(</span><span class="n">digits</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;cannot refer to an open group&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">make_ref_group</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">digits</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_octal_escape</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">digits</span><span class="p">,</span> <span class="n">in_set</span><span class="p">):</span>
    <span class="s2">&quot;Parses an octal escape sequence.&quot;</span>
    <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">OCT_DIGITS</span><span class="p">:</span>
        <span class="n">digits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
        <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">digits</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">make_character</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">in_set</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">digits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">OCT_DIGITS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;incomplete escape </span><span class="se">\\</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">digits</span><span class="p">),</span>
              <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;bad escape </span><span class="se">\\</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">digits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
              <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_hex_escape</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">esc</span><span class="p">,</span> <span class="n">expected_len</span><span class="p">,</span> <span class="n">in_set</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
    <span class="s2">&quot;Parses a hex escape sequence.&quot;</span>
    <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
    <span class="n">digits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">expected_len</span><span class="p">):</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">HEX_DIGITS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;incomplete escape </span><span class="se">\\</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">digits</span><span class="p">)),</span>
              <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">saved_pos</span><span class="p">)</span>
        <span class="n">digits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">digits</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mh">0x110000</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_character</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">in_set</span><span class="p">)</span>

    <span class="c1"># Bad hex escape.</span>
    <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;bad hex escape </span><span class="se">\\</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">esc</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">digits</span><span class="p">)),</span>
      <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">saved_pos</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_group_ref</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="s2">&quot;Parses a group reference.&quot;</span>
    <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">)</span>
    <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">parse_name</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">is_open_group</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;cannot refer to an open group&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">make_ref_group</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">saved_pos</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_string_set</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="s2">&quot;Parses a string set reference.&quot;</span>
    <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">parse_name</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;undefined named list&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">make_string_set</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_named_char</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">in_set</span><span class="p">):</span>
    <span class="s2">&quot;Parses a named character.&quot;</span>
    <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
    <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get_while</span><span class="p">(</span><span class="n">NAMED_CHAR_PART</span><span class="p">,</span> <span class="n">keep_spaces</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">make_character</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">in_set</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;undefined character name&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
                  <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

    <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>
    <span class="k">return</span> <span class="n">make_character</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">),</span> <span class="n">in_set</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_property</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">positive</span><span class="p">,</span> <span class="n">in_set</span><span class="p">):</span>
    <span class="s2">&quot;Parses a Unicode property.&quot;</span>
    <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;{&quot;</span><span class="p">:</span>
        <span class="n">negate</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">)</span>
        <span class="n">prop_name</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">parse_property_name</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">):</span>
            <span class="c1"># It&#39;s correctly delimited.</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="n">lookup_property</span><span class="p">(</span><span class="n">prop_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">positive</span> <span class="o">!=</span> <span class="n">negate</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">make_property</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">in_set</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ch</span> <span class="ow">and</span> <span class="n">ch</span> <span class="ow">in</span> <span class="s2">&quot;CLMNPSZ&quot;</span><span class="p">:</span>
        <span class="c1"># An abbreviated property, eg \pL.</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="n">lookup_property</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">positive</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">make_property</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">in_set</span><span class="p">)</span>

    <span class="c1"># Not a property, so treat as a literal &quot;p&quot; or &quot;P&quot;.</span>
    <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="s2">&quot;p&quot;</span> <span class="k">if</span> <span class="n">positive</span> <span class="k">else</span> <span class="s2">&quot;P&quot;</span>
    <span class="k">return</span> <span class="n">make_character</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="n">in_set</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_property_name</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="s2">&quot;Parses a property name, which may be qualified.&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get_while</span><span class="p">(</span><span class="n">PROPERTY_NAME_PART</span><span class="p">)</span>
    <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>

    <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ch</span> <span class="ow">and</span> <span class="n">ch</span> <span class="ow">in</span> <span class="s2">&quot;:=&quot;</span><span class="p">:</span>
        <span class="n">prop_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get_while</span><span class="p">(</span><span class="n">ALNUM</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="s2">&quot; &amp;_-./&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="c1"># Name after the &quot;:&quot; or &quot;=&quot;, so it&#39;s a qualified name.</span>
            <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No name after the &quot;:&quot; or &quot;=&quot;, so assume it&#39;s an unqualified name.</span>
            <span class="n">prop_name</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">prop_name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prop_name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>
    <span class="k">return</span> <span class="n">prop_name</span><span class="p">,</span> <span class="n">name</span>

<span class="k">def</span> <span class="nf">parse_set</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="s2">&quot;Parses a character set.&quot;</span>
    <span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">_ALL_VERSIONS</span><span class="p">)</span> <span class="ow">or</span> <span class="n">DEFAULT_VERSION</span>

    <span class="n">saved_ignore</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">ignore_space</span>
    <span class="n">source</span><span class="o">.</span><span class="n">ignore_space</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Negative set?</span>
    <span class="n">negate</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">VERSION0</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">parse_set_imp_union</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">parse_set_union</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;missing ]&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">source</span><span class="o">.</span><span class="n">ignore_space</span> <span class="o">=</span> <span class="n">saved_ignore</span>

    <span class="k">if</span> <span class="n">negate</span><span class="p">:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">with_flags</span><span class="p">(</span><span class="n">positive</span><span class="o">=</span><span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">positive</span><span class="p">)</span>

    <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">with_flags</span><span class="p">(</span><span class="n">case_flags</span><span class="o">=</span><span class="n">make_case_flags</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">item</span>

<span class="k">def</span> <span class="nf">parse_set_union</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="s2">&quot;Parses a set union ([x||y]).&quot;</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">parse_set_symm_diff</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)]</span>
    <span class="k">while</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;||&quot;</span><span class="p">):</span>
        <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse_set_symm_diff</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">SetUnion</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_set_symm_diff</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="s2">&quot;Parses a set symmetric difference ([x~~y]).&quot;</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">parse_set_inter</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)]</span>
    <span class="k">while</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;~~&quot;</span><span class="p">):</span>
        <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse_set_inter</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">SetSymDiff</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_set_inter</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="s2">&quot;Parses a set intersection ([x&amp;&amp;y]).&quot;</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">parse_set_diff</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)]</span>
    <span class="k">while</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;&amp;&amp;&quot;</span><span class="p">):</span>
        <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse_set_diff</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">SetInter</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_set_diff</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="s2">&quot;Parses a set difference ([x--y]).&quot;</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">parse_set_imp_union</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)]</span>
    <span class="k">while</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="p">):</span>
        <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse_set_imp_union</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">SetDiff</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_set_imp_union</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="s2">&quot;Parses a set implicit union ([xy]).&quot;</span>
    <span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">_ALL_VERSIONS</span><span class="p">)</span> <span class="ow">or</span> <span class="n">DEFAULT_VERSION</span>

    <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">parse_set_member</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)]</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
        <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">):</span>
            <span class="c1"># End of the set.</span>
            <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">VERSION1</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">SET_OPS</span><span class="p">):</span>
            <span class="c1"># The new behaviour has set operators.</span>
            <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>
            <span class="k">break</span>

        <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse_set_member</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">SetUnion</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_set_member</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="s2">&quot;Parses a member in a character set.&quot;</span>
    <span class="c1"># Parse a set item.</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">parse_set_item</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
    <span class="n">saved_pos1</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">Character</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">start</span><span class="o">.</span><span class="n">positive</span> <span class="ow">or</span> <span class="ow">not</span>
      <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)):</span>
        <span class="c1"># It&#39;s not the start of a range.</span>
        <span class="k">return</span> <span class="n">start</span>

    <span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">_ALL_VERSIONS</span><span class="p">)</span> <span class="ow">or</span> <span class="n">DEFAULT_VERSION</span>

    <span class="c1"># It looks like the start of a range of characters.</span>
    <span class="n">saved_pos2</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">VERSION1</span> <span class="ow">and</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
        <span class="c1"># It&#39;s actually the set difference operator &#39;--&#39;, so return the</span>
        <span class="c1"># character.</span>
        <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos1</span>
        <span class="k">return</span> <span class="n">start</span>

    <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">):</span>
        <span class="c1"># We&#39;ve reached the end of the set, so return both the character and</span>
        <span class="c1"># hyphen.</span>
        <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos2</span>
        <span class="k">return</span> <span class="n">SetUnion</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">Character</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))])</span>

    <span class="c1"># Parse a set item.</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">parse_set_item</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">Character</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">end</span><span class="o">.</span><span class="n">positive</span><span class="p">:</span>
        <span class="c1"># It&#39;s not a range, so return the character, hyphen and property.</span>
        <span class="k">return</span> <span class="n">SetUnion</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">Character</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)),</span> <span class="n">end</span><span class="p">])</span>

    <span class="c1"># It _is_ a range.</span>
    <span class="k">if</span> <span class="n">start</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">end</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;bad character range&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">start</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">end</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">start</span>

    <span class="k">return</span> <span class="n">Range</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">end</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_set_item</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="s2">&quot;Parses an item in a character set.&quot;</span>
    <span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">_ALL_VERSIONS</span><span class="p">)</span> <span class="ow">or</span> <span class="n">DEFAULT_VERSION</span>

    <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="c1"># An escape sequence in a set.</span>
        <span class="k">return</span> <span class="n">parse_escape</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
    <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;[:&quot;</span><span class="p">):</span>
        <span class="c1"># Looks like a POSIX character class.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parse_posix_class</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ParseError</span><span class="p">:</span>
            <span class="c1"># Not a POSIX character class.</span>
            <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>

    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">VERSION1</span> <span class="ow">and</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">):</span>
        <span class="c1"># It&#39;s the start of a nested set.</span>

        <span class="c1"># Negative set?</span>
        <span class="n">negate</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">parse_set_union</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;missing ]&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">negate</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">with_flags</span><span class="p">(</span><span class="n">positive</span><span class="o">=</span><span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">positive</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">item</span>

    <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ch</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;unterminated character set&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Character</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">parse_posix_class</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="s2">&quot;Parses a POSIX character class.&quot;</span>
    <span class="n">negate</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">)</span>
    <span class="n">prop_name</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">parse_property_name</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;:]&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ParseError</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">lookup_property</span><span class="p">(</span><span class="n">prop_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="ow">not</span> <span class="n">negate</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">posix</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">float_to_rational</span><span class="p">(</span><span class="n">flt</span><span class="p">):</span>
    <span class="s2">&quot;Converts a float to a rational pair.&quot;</span>
    <span class="n">int_part</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">flt</span><span class="p">)</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">flt</span> <span class="o">-</span> <span class="n">int_part</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0001</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">int_part</span><span class="p">,</span> <span class="mi">1</span>

    <span class="n">den</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="n">float_to_rational</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">error</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">int_part</span> <span class="o">*</span> <span class="n">den</span> <span class="o">+</span> <span class="n">num</span><span class="p">,</span> <span class="n">den</span>

<span class="k">def</span> <span class="nf">numeric_to_rational</span><span class="p">(</span><span class="n">numeric</span><span class="p">):</span>
    <span class="s2">&quot;Converts a numeric string to a rational string, if possible.&quot;</span>
    <span class="k">if</span> <span class="n">numeric</span><span class="p">[</span> <span class="p">:</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
        <span class="n">sign</span><span class="p">,</span> <span class="n">numeric</span> <span class="o">=</span> <span class="n">numeric</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">numeric</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">parts</span> <span class="o">=</span> <span class="n">numeric</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">num</span><span class="p">,</span> <span class="n">den</span> <span class="o">=</span> <span class="n">float_to_rational</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">num</span><span class="p">,</span> <span class="n">den</span> <span class="o">=</span> <span class="n">float_to_rational</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sign</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">den</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/1&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">[</span> <span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">standardise_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="s2">&quot;Standardises a property or value name.&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numeric_to_rational</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">ZeroDivisionError</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">name</span> <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">&quot;_- &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

<span class="n">_POSIX_CLASSES</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="s1">&#39;ALNUM DIGIT PUNCT XDIGIT&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

<span class="n">_BINARY_VALUES</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="s1">&#39;YES Y NO N TRUE T FALSE F&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">lookup_property</span><span class="p">(</span><span class="nb">property</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">positive</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">posix</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="s2">&quot;Looks up a property.&quot;</span>
    <span class="c1"># Normalise the names (which may still be lists).</span>
    <span class="nb">property</span> <span class="o">=</span> <span class="n">standardise_name</span><span class="p">(</span><span class="nb">property</span><span class="p">)</span> <span class="k">if</span> <span class="nb">property</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">standardise_name</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">property</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;GENERALCATEGORY&quot;</span><span class="p">,</span> <span class="s2">&quot;ASSIGNED&quot;</span><span class="p">):</span>
        <span class="nb">property</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">positive</span> <span class="o">=</span> <span class="s2">&quot;GENERALCATEGORY&quot;</span><span class="p">,</span> <span class="s2">&quot;UNASSIGNED&quot;</span><span class="p">,</span> <span class="ow">not</span> <span class="n">positive</span>

    <span class="k">if</span> <span class="n">posix</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">property</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">_POSIX_CLASSES</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;POSIX&#39;</span> <span class="o">+</span> <span class="n">value</span>

    <span class="k">if</span> <span class="nb">property</span><span class="p">:</span>
        <span class="c1"># Both the property and the value are provided.</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="n">PROPERTIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">property</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prop</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;unknown property&quot;</span><span class="p">)</span>

            <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;unknown property&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">prop_id</span><span class="p">,</span> <span class="n">value_dict</span> <span class="o">=</span> <span class="n">prop</span>
        <span class="n">val_id</span> <span class="o">=</span> <span class="n">value_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;unknown property value&quot;</span><span class="p">)</span>

            <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;unknown property value&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Property</span><span class="p">((</span><span class="n">prop_id</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">val_id</span><span class="p">,</span> <span class="n">positive</span><span class="p">)</span>

    <span class="c1"># Only the value is provided.</span>
    <span class="c1"># It might be the name of a GC, script or block value.</span>
    <span class="k">for</span> <span class="nb">property</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;GC&quot;</span><span class="p">,</span> <span class="s2">&quot;SCRIPT&quot;</span><span class="p">,</span> <span class="s2">&quot;BLOCK&quot;</span><span class="p">):</span>
        <span class="n">prop_id</span><span class="p">,</span> <span class="n">value_dict</span> <span class="o">=</span> <span class="n">PROPERTIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">property</span><span class="p">)</span>
        <span class="n">val_id</span> <span class="o">=</span> <span class="n">value_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Property</span><span class="p">((</span><span class="n">prop_id</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">val_id</span><span class="p">,</span> <span class="n">positive</span><span class="p">)</span>

    <span class="c1"># It might be the name of a binary property.</span>
    <span class="n">prop</span> <span class="o">=</span> <span class="n">PROPERTIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">prop</span><span class="p">:</span>
        <span class="n">prop_id</span><span class="p">,</span> <span class="n">value_dict</span> <span class="o">=</span> <span class="n">prop</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">value_dict</span><span class="p">)</span> <span class="o">==</span> <span class="n">_BINARY_VALUES</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Property</span><span class="p">((</span><span class="n">prop_id</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="n">positive</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Property</span><span class="p">(</span><span class="n">prop_id</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span> <span class="ow">not</span> <span class="n">positive</span><span class="p">)</span>

    <span class="c1"># It might be the name of a binary property starting with a prefix.</span>
    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;IS&quot;</span><span class="p">):</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="n">PROPERTIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">2</span> <span class="p">:</span> <span class="p">])</span>
        <span class="k">if</span> <span class="n">prop</span><span class="p">:</span>
            <span class="n">prop_id</span><span class="p">,</span> <span class="n">value_dict</span> <span class="o">=</span> <span class="n">prop</span>
            <span class="k">if</span> <span class="s2">&quot;YES&quot;</span> <span class="ow">in</span> <span class="n">value_dict</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Property</span><span class="p">((</span><span class="n">prop_id</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="n">positive</span><span class="p">)</span>

    <span class="c1"># It might be the name of a script or block starting with a prefix.</span>
    <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="nb">property</span> <span class="ow">in</span> <span class="p">((</span><span class="s2">&quot;IS&quot;</span><span class="p">,</span> <span class="s2">&quot;SCRIPT&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;IN&quot;</span><span class="p">,</span> <span class="s2">&quot;BLOCK&quot;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="n">prop_id</span><span class="p">,</span> <span class="n">value_dict</span> <span class="o">=</span> <span class="n">PROPERTIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">property</span><span class="p">)</span>
            <span class="n">val_id</span> <span class="o">=</span> <span class="n">value_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">2</span> <span class="p">:</span> <span class="p">])</span>
            <span class="k">if</span> <span class="n">val_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Property</span><span class="p">((</span><span class="n">prop_id</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">val_id</span><span class="p">,</span> <span class="n">positive</span><span class="p">)</span>

    <span class="c1"># Unknown property.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;unknown property&quot;</span><span class="p">)</span>

    <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;unknown property&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_compile_replacement</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">is_unicode</span><span class="p">):</span>
    <span class="s2">&quot;Compiles a replacement template escape sequence.&quot;</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">ALPHA</span><span class="p">:</span>
        <span class="c1"># An alphabetic escape sequence.</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">CHARACTER_ESCAPES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">HEX_ESCAPES</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span> <span class="ow">or</span> <span class="n">is_unicode</span><span class="p">):</span>
            <span class="c1"># A hexadecimal escape sequence.</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="n">parse_repl_hex_escape</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">HEX_ESCAPES</span><span class="p">[</span><span class="n">ch</span><span class="p">],</span> <span class="n">ch</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;g&quot;</span><span class="p">:</span>
            <span class="c1"># A group preference.</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="n">compile_repl_group</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;N&quot;</span> <span class="ow">and</span> <span class="n">is_unicode</span><span class="p">:</span>
            <span class="c1"># A named character.</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">parse_repl_named_char</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>

        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;bad escape </span><span class="se">\\</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ch</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="n">octal_mask</span> <span class="o">=</span> <span class="mh">0xFF</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">octal_mask</span> <span class="o">=</span> <span class="mh">0x1FF</span>

    <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
        <span class="c1"># An octal escape sequence.</span>
        <span class="n">digits</span> <span class="o">=</span> <span class="n">ch</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">OCT_DIGITS</span><span class="p">:</span>
                <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>
                <span class="k">break</span>
            <span class="n">digits</span> <span class="o">+=</span> <span class="n">ch</span>

        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">digits</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">octal_mask</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">DIGITS</span><span class="p">:</span>
        <span class="c1"># Either an octal escape sequence (3 digits) or a group reference (max</span>
        <span class="c1"># 2 digits).</span>
        <span class="n">digits</span> <span class="o">=</span> <span class="n">ch</span>
        <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">DIGITS</span><span class="p">:</span>
            <span class="n">digits</span> <span class="o">+=</span> <span class="n">ch</span>
            <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ch</span> <span class="ow">and</span> <span class="n">is_octal</span><span class="p">(</span><span class="n">digits</span> <span class="o">+</span> <span class="n">ch</span><span class="p">):</span>
                <span class="c1"># An octal escape sequence.</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">digits</span> <span class="o">+</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">octal_mask</span><span class="p">]</span>

        <span class="c1"># A group reference.</span>
        <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">digits</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">:</span>
        <span class="c1"># An escaped backslash is a backslash.</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ch</span><span class="p">:</span>
        <span class="c1"># A trailing backslash.</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;bad escape (end of pattern)&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

    <span class="c1"># An escaped non-backslash is a backslash followed by the literal.</span>
    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">),</span> <span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">)]</span>

<span class="k">def</span> <span class="nf">parse_repl_hex_escape</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">expected_len</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
    <span class="s2">&quot;Parses a hex escape sequence in a replacement string.&quot;</span>
    <span class="n">digits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">expected_len</span><span class="p">):</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">HEX_DIGITS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;incomplete escape </span><span class="se">\\</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">digits</span><span class="p">)),</span>
              <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">digits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">digits</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse_repl_named_char</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="s2">&quot;Parses a named character in a replacement string.&quot;</span>
    <span class="n">saved_pos</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span>
    <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get_while</span><span class="p">(</span><span class="n">ALPHA</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">ord</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;undefined character name&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
                  <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

    <span class="n">source</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">saved_pos</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">compile_repl_group</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
    <span class="s2">&quot;Compiles a replacement template group reference.&quot;</span>
    <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">parse_name</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">source</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;invalid group reference&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">index</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pattern</span><span class="o">.</span><span class="n">groupindex</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;unknown group&quot;</span><span class="p">)</span>

<span class="c1"># The regular expression is parsed into a syntax tree. The different types of</span>
<span class="c1"># node are defined below.</span>

<span class="n">INDENT</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
<span class="n">POSITIVE_OP</span> <span class="o">=</span> <span class="mh">0x1</span>
<span class="n">ZEROWIDTH_OP</span> <span class="o">=</span> <span class="mh">0x2</span>
<span class="n">FUZZY_OP</span> <span class="o">=</span> <span class="mh">0x4</span>
<span class="n">REVERSE_OP</span> <span class="o">=</span> <span class="mh">0x8</span>
<span class="n">REQUIRED_OP</span> <span class="o">=</span> <span class="mh">0x10</span>

<span class="n">POS_TEXT</span> <span class="o">=</span> <span class="p">{</span><span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;NON-MATCH&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">:</span> <span class="s2">&quot;MATCH&quot;</span><span class="p">}</span>
<span class="n">CASE_TEXT</span> <span class="o">=</span> <span class="p">{</span><span class="n">NOCASE</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">IGNORECASE</span><span class="p">:</span> <span class="s2">&quot; SIMPLE_IGNORE_CASE&quot;</span><span class="p">,</span> <span class="n">FULLCASE</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
  <span class="n">FULLIGNORECASE</span><span class="p">:</span> <span class="s2">&quot; FULL_IGNORE_CASE&quot;</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">make_sequence</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Sequence</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

<span class="c1"># Common base class for all nodes.</span>
<span class="k">class</span> <span class="nc">RegexBase</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>

    <span class="k">def</span> <span class="nf">with_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">case_flags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zerowidth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">positive</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">positive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">positive</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">positive</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">case_flags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">case_flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">case_flags</span> <span class="o">=</span> <span class="n">CASE_FLAGS_COMBINATIONS</span><span class="p">[</span><span class="n">case_flags</span> <span class="o">&amp;</span> <span class="n">CASE_FLAGS</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">zerowidth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">zerowidth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zerowidth</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zerowidth</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">zerowidth</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">positive</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span> <span class="ow">and</span> <span class="n">case_flags</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span> <span class="ow">and</span>
          <span class="n">zerowidth</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">zerowidth</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rebuild</span><span class="p">(</span><span class="n">positive</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">,</span> <span class="n">zerowidth</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fix_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">optimise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">pack_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">remove_captures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">is_atomic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">can_be_affix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">contains_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">get_firstset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">_FirstSetError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">has_simple_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fuzzy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_key</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_required_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_width</span><span class="p">(),</span> <span class="kc">None</span>

<span class="c1"># Base class for zero-width nodes.</span>
<span class="k">class</span> <span class="nc">ZeroWidthBase</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">RegexBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positive</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">positive</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span>

    <span class="k">def</span> <span class="nf">get_firstset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">([</span><span class="kc">None</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">POSITIVE_OP</span>
        <span class="k">if</span> <span class="n">fuzzy</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">FUZZY_OP</span>
        <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">REVERSE_OP</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_opcode</span><span class="p">,</span> <span class="n">flags</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op_name</span><span class="p">,</span>
          <span class="n">POS_TEXT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">max_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>

<span class="k">class</span> <span class="nc">Any</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="p">{</span><span class="kc">False</span><span class="p">:</span> <span class="n">OP</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="kc">True</span><span class="p">:</span> <span class="n">OP</span><span class="o">.</span><span class="n">ANY_REV</span><span class="p">}</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;ANY&quot;</span>

    <span class="k">def</span> <span class="nf">has_simple_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">fuzzy</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">FUZZY_OP</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_opcode</span><span class="p">[</span><span class="n">reverse</span><span class="p">],</span> <span class="n">flags</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op_name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">max_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>

<span class="k">class</span> <span class="nc">AnyAll</span><span class="p">(</span><span class="n">Any</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="p">{</span><span class="kc">False</span><span class="p">:</span> <span class="n">OP</span><span class="o">.</span><span class="n">ANY_ALL</span><span class="p">,</span> <span class="kc">True</span><span class="p">:</span> <span class="n">OP</span><span class="o">.</span><span class="n">ANY_ALL_REV</span><span class="p">}</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;ANY_ALL&quot;</span>

<span class="k">class</span> <span class="nc">AnyU</span><span class="p">(</span><span class="n">Any</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="p">{</span><span class="kc">False</span><span class="p">:</span> <span class="n">OP</span><span class="o">.</span><span class="n">ANY_U</span><span class="p">,</span> <span class="kc">True</span><span class="p">:</span> <span class="n">OP</span><span class="o">.</span><span class="n">ANY_U_REV</span><span class="p">}</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;ANY_U&quot;</span>

<span class="k">class</span> <span class="nc">Atomic</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subpattern</span><span class="p">):</span>
        <span class="n">RegexBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span> <span class="o">=</span> <span class="n">subpattern</span>

    <span class="k">def</span> <span class="nf">fix_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">fix_groups</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">optimise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">pack_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">pack_characters</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">remove_captures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">remove_captures</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">can_be_affix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">can_be_affix</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">contains_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">contains_group</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_firstset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">get_firstset</span><span class="p">(</span><span class="n">reverse</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_simple_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">has_simple_start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">([(</span><span class="n">OP</span><span class="o">.</span><span class="n">ATOMIC</span><span class="p">,</span> <span class="p">)]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">)</span> <span class="o">+</span>
          <span class="p">[(</span><span class="n">OP</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="p">)])</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">ATOMIC&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span> <span class="o">==</span>
          <span class="n">other</span><span class="o">.</span><span class="n">subpattern</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">max_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">max_width</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_required_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">get_required_string</span><span class="p">(</span><span class="n">reverse</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Boundary</span><span class="p">(</span><span class="n">ZeroWidthBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">BOUNDARY</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;BOUNDARY&quot;</span>

<span class="k">class</span> <span class="nc">Branch</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branches</span><span class="p">):</span>
        <span class="n">RegexBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">branches</span> <span class="o">=</span> <span class="n">branches</span>

    <span class="k">def</span> <span class="nf">fix_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
            <span class="n">b</span><span class="o">.</span><span class="n">fix_groups</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">optimise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Sequence</span><span class="p">([])</span>

        <span class="c1"># Flatten branches within branches.</span>
        <span class="n">branches</span> <span class="o">=</span> <span class="n">Branch</span><span class="o">.</span><span class="n">_flatten_branches</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">)</span>

        <span class="c1"># Move any common prefix or suffix out of the branches.</span>
        <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="n">suffix</span><span class="p">,</span> <span class="n">branches</span> <span class="o">=</span> <span class="n">Branch</span><span class="o">.</span><span class="n">_split_common_suffix</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">branches</span><span class="p">)</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prefix</span><span class="p">,</span> <span class="n">branches</span> <span class="o">=</span> <span class="n">Branch</span><span class="o">.</span><span class="n">_split_common_prefix</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">branches</span><span class="p">)</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Try to reduce adjacent single-character branches to sets.</span>
        <span class="n">branches</span> <span class="o">=</span> <span class="n">Branch</span><span class="o">.</span><span class="n">_reduce_to_set</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">branches</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">sequence</span> <span class="o">=</span> <span class="p">[</span><span class="n">Branch</span><span class="p">(</span><span class="n">branches</span><span class="p">)]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">prefix</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">suffix</span><span class="p">:</span>
                <span class="c1"># We might be able to add a quick precheck before the branches.</span>
                <span class="n">firstset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_precheck</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">branches</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">firstset</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
                        <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">firstset</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sequence</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">firstset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sequence</span> <span class="o">=</span> <span class="n">branches</span>

        <span class="k">return</span> <span class="n">make_sequence</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">sequence</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_precheck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">branches</span><span class="p">):</span>
        <span class="n">charset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">reverse</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">branch</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Literal</span> <span class="ow">and</span> <span class="n">branch</span><span class="o">.</span><span class="n">case_flags</span> <span class="o">==</span> <span class="n">NOCASE</span><span class="p">:</span>
                <span class="n">charset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">branch</span><span class="o">.</span><span class="n">characters</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">charset</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">_check_firstset</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="p">[</span><span class="n">Character</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">charset</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">pack_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">branches</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">pack_characters</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">remove_captures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">branches</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">remove_captures</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">is_atomic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">is_atomic</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">can_be_affix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">can_be_affix</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">contains_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">contains_group</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_firstset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
            <span class="n">fs</span> <span class="o">|=</span> <span class="n">b</span><span class="o">.</span><span class="n">get_firstset</span><span class="p">(</span><span class="n">reverse</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fs</span> <span class="ow">or</span> <span class="nb">set</span><span class="p">([</span><span class="kc">None</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">code</span> <span class="o">=</span> <span class="p">[(</span><span class="n">OP</span><span class="o">.</span><span class="n">BRANCH</span><span class="p">,</span> <span class="p">)]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">:</span>
            <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">))</span>
            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">OP</span><span class="o">.</span><span class="n">NEXT</span><span class="p">,</span> <span class="p">))</span>

        <span class="n">code</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">BRANCH&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">OR&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">))</span>
            <span class="n">b</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_flatten_branches</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">branches</span><span class="p">):</span>
        <span class="c1"># Flatten the branches so that there aren&#39;t branches of branches.</span>
        <span class="n">new_branches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">Branch</span><span class="p">):</span>
                <span class="n">new_branches</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">branches</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_branches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_branches</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_split_common_prefix</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">branches</span><span class="p">):</span>
        <span class="c1"># Common leading items can be moved out of the branches.</span>
        <span class="c1"># Get the items in the branches.</span>
        <span class="n">alternatives</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
                <span class="n">alternatives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alternatives</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">b</span><span class="p">])</span>

        <span class="c1"># What is the maximum possible length of the prefix?</span>
        <span class="n">max_count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alternatives</span><span class="p">)</span>

        <span class="c1"># What is the longest common prefix?</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">alternatives</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">end_pos</span> <span class="o">=</span> <span class="n">max_count</span>
        <span class="k">while</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">end_pos</span> <span class="ow">and</span> <span class="n">prefix</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">can_be_affix</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span>
          <span class="n">prefix</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alternatives</span><span class="p">):</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">pos</span>

        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UNICODE</span><span class="p">:</span>
            <span class="c1"># We need to check that we&#39;re not splitting a sequence of</span>
            <span class="c1"># characters which could form part of full case-folding.</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">pos</span>
            <span class="k">while</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">Branch</span><span class="o">.</span><span class="n">_can_split</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span>
              <span class="n">alternatives</span><span class="p">):</span>
                <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1"># No common prefix is possible.</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="n">branches</span>

        <span class="c1"># Rebuild the branches.</span>
        <span class="n">new_branches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alternatives</span><span class="p">:</span>
            <span class="n">new_branches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_sequence</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">count</span> <span class="p">:</span> <span class="p">]))</span>

        <span class="k">return</span> <span class="n">prefix</span><span class="p">[</span> <span class="p">:</span> <span class="n">count</span><span class="p">],</span> <span class="n">new_branches</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_split_common_suffix</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">branches</span><span class="p">):</span>
        <span class="c1"># Common trailing items can be moved out of the branches.</span>
        <span class="c1"># Get the items in the branches.</span>
        <span class="n">alternatives</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
                <span class="n">alternatives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alternatives</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">b</span><span class="p">])</span>

        <span class="c1"># What is the maximum possible length of the suffix?</span>
        <span class="n">max_count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alternatives</span><span class="p">)</span>

        <span class="c1"># What is the longest common suffix?</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">alternatives</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">end_pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">max_count</span>
        <span class="k">while</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="n">end_pos</span> <span class="ow">and</span> <span class="n">suffix</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">can_be_affix</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span>
          <span class="n">suffix</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alternatives</span><span class="p">):</span>
            <span class="n">pos</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pos</span>

        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UNICODE</span><span class="p">:</span>
            <span class="c1"># We need to check that we&#39;re not splitting a sequence of</span>
            <span class="c1"># characters which could form part of full case-folding.</span>
            <span class="k">while</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">Branch</span><span class="o">.</span><span class="n">_can_split_rev</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span>
              <span class="ow">in</span> <span class="n">alternatives</span><span class="p">):</span>
                <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1"># No common suffix is possible.</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="n">branches</span>

        <span class="c1"># Rebuild the branches.</span>
        <span class="n">new_branches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alternatives</span><span class="p">:</span>
            <span class="n">new_branches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_sequence</span><span class="p">(</span><span class="n">a</span><span class="p">[</span> <span class="p">:</span> <span class="o">-</span><span class="n">count</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">suffix</span><span class="p">[</span><span class="o">-</span><span class="n">count</span> <span class="p">:</span> <span class="p">],</span> <span class="n">new_branches</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_can_split</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
        <span class="c1"># Check the characters either side of the proposed split.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Branch</span><span class="o">.</span><span class="n">_is_full_case</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">Branch</span><span class="o">.</span><span class="n">_is_full_case</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Check whether a 1-1 split would be OK.</span>
        <span class="k">if</span> <span class="n">Branch</span><span class="o">.</span><span class="n">_is_folded</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check whether a 1-2 split would be OK.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Branch</span><span class="o">.</span><span class="n">_is_full_case</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span>
          <span class="n">Branch</span><span class="o">.</span><span class="n">_is_folded</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check whether a 2-1 split would be OK.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Branch</span><span class="o">.</span><span class="n">_is_full_case</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span>
          <span class="n">Branch</span><span class="o">.</span><span class="n">_is_folded</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">:</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_can_split_rev</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

        <span class="c1"># Check the characters either side of the proposed split.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Branch</span><span class="o">.</span><span class="n">_is_full_case</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">count</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">Branch</span><span class="o">.</span><span class="n">_is_full_case</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Check whether a 1-1 split would be OK.</span>
        <span class="k">if</span> <span class="n">Branch</span><span class="o">.</span><span class="n">_is_folded</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">end</span> <span class="o">-</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">end</span> <span class="o">-</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check whether a 1-2 split would be OK.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Branch</span><span class="o">.</span><span class="n">_is_full_case</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span>
          <span class="n">Branch</span><span class="o">.</span><span class="n">_is_folded</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">end</span> <span class="o">-</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">end</span> <span class="o">-</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check whether a 2-1 split would be OK.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Branch</span><span class="o">.</span><span class="n">_is_full_case</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span>
          <span class="n">Branch</span><span class="o">.</span><span class="n">_is_folded</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">end</span> <span class="o">-</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">:</span> <span class="n">end</span> <span class="o">-</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_merge_common_prefixes</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">branches</span><span class="p">):</span>
        <span class="c1"># Branches with the same case-sensitive character prefix can be grouped</span>
        <span class="c1"># together if they are separated only by other branches with a</span>
        <span class="c1"># character prefix.</span>
        <span class="n">prefixed</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">order</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">new_branches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Branch</span><span class="o">.</span><span class="n">_is_simple_character</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
                <span class="c1"># Branch starts with a simple character.</span>
                <span class="n">prefixed</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">b</span><span class="p">])</span>
                <span class="n">order</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">items</span> <span class="ow">and</span>
              <span class="n">Branch</span><span class="o">.</span><span class="n">_is_simple_character</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="c1"># Branch starts with a simple character.</span>
                <span class="n">prefixed</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
                <span class="n">order</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Branch</span><span class="o">.</span><span class="n">_flush_char_prefix</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">prefixed</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span>
                  <span class="n">new_branches</span><span class="p">)</span>

                <span class="n">new_branches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

        <span class="n">Branch</span><span class="o">.</span><span class="n">_flush_char_prefix</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">prefixed</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">new_branches</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_branches</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_is_simple_character</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Character</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">positive</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">case_flags</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_reduce_to_set</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">branches</span><span class="p">):</span>
        <span class="c1"># Can the branches be reduced to a set?</span>
        <span class="n">new_branches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">case_flags</span> <span class="o">=</span> <span class="n">NOCASE</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="n">Character</span><span class="p">,</span> <span class="n">Property</span><span class="p">,</span> <span class="n">SetBase</span><span class="p">)):</span>
                <span class="c1"># Branch starts with a single character.</span>
                <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">case_flags</span> <span class="o">!=</span> <span class="n">case_flags</span><span class="p">:</span>
                    <span class="c1"># Different case sensitivity, so flush.</span>
                    <span class="n">Branch</span><span class="o">.</span><span class="n">_flush_set_members</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">,</span>
                      <span class="n">new_branches</span><span class="p">)</span>

                    <span class="n">case_flags</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">case_flags</span>

                <span class="n">items</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">with_flags</span><span class="p">(</span><span class="n">case_flags</span><span class="o">=</span><span class="n">NOCASE</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Branch</span><span class="o">.</span><span class="n">_flush_set_members</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">,</span>
                  <span class="n">new_branches</span><span class="p">)</span>

                <span class="n">new_branches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

        <span class="n">Branch</span><span class="o">.</span><span class="n">_flush_set_members</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">,</span>
          <span class="n">new_branches</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">new_branches</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_flush_char_prefix</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">prefixed</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">new_branches</span><span class="p">):</span>
        <span class="c1"># Flush the prefixed branches.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prefixed</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">branches</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">prefixed</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pair</span><span class="p">:</span>
          <span class="n">order</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]]):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">branches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">new_branches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_sequence</span><span class="p">(</span><span class="n">branches</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subbranches</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">optional</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">subbranches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_sequence</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="p">]))</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">optional</span><span class="p">:</span>
                        <span class="n">subbranches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Sequence</span><span class="p">())</span>
                        <span class="n">optional</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">sequence</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">([</span><span class="n">Character</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">Branch</span><span class="p">(</span><span class="n">subbranches</span><span class="p">)])</span>
                <span class="n">new_branches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sequence</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">))</span>

        <span class="n">prefixed</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">order</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_flush_set_members</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">,</span> <span class="n">new_branches</span><span class="p">):</span>
        <span class="c1"># Flush the set members.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">items</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">SetUnion</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">items</span><span class="p">))</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>

        <span class="n">new_branches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">with_flags</span><span class="p">(</span><span class="n">case_flags</span><span class="o">=</span><span class="n">case_flags</span><span class="p">))</span>

        <span class="n">items</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_is_full_case</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">item</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Character</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">positive</span> <span class="ow">and</span>
          <span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">case_flags</span> <span class="o">&amp;</span> <span class="n">FULLIGNORECASE</span><span class="p">)</span> <span class="o">==</span> <span class="n">FULLIGNORECASE</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_is_folded</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Character</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">positive</span> <span class="ow">or</span> <span class="ow">not</span>
              <span class="n">i</span><span class="o">.</span><span class="n">case_flags</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="n">folded</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span><span class="p">)</span>
        <span class="n">folded</span> <span class="o">=</span> <span class="n">_regex</span><span class="o">.</span><span class="n">fold_case</span><span class="p">(</span><span class="n">FULL_CASE_FOLDING</span><span class="p">,</span> <span class="n">folded</span><span class="p">)</span>

        <span class="c1"># Get the characters which expand to multiple codepoints on folding.</span>
        <span class="n">expanding_chars</span> <span class="o">=</span> <span class="n">_regex</span><span class="o">.</span><span class="n">get_expand_on_folding</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">expanding_chars</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">folded</span> <span class="o">==</span> <span class="n">_regex</span><span class="o">.</span><span class="n">fold_case</span><span class="p">(</span><span class="n">FULL_CASE_FOLDING</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">branches</span>

    <span class="k">def</span> <span class="nf">max_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">max_width</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">branches</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">CallGroup</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="n">RegexBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">position</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span>

    <span class="k">def</span> <span class="nf">fix_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">group_index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;invalid group reference&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">group_count</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;unknown group&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">open_group_count</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;ambiguous group reference&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">group_calls</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span>

    <span class="k">def</span> <span class="nf">remove_captures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;group reference not allowed&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">OP</span><span class="o">.</span><span class="n">GROUP_CALL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_ref</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">GROUP_CALL </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">group</span>

    <span class="k">def</span> <span class="nf">max_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">UNLIMITED</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">CallRef</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">parsed</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parsed</span> <span class="o">=</span> <span class="n">parsed</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">([(</span><span class="n">OP</span><span class="o">.</span><span class="n">CALL_REF</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="p">)]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed</span><span class="o">.</span><span class="n">_compile</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span>
          <span class="n">fuzzy</span><span class="p">)</span> <span class="o">+</span> <span class="p">[(</span><span class="n">OP</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="p">)])</span>

<span class="k">class</span> <span class="nc">Character</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="p">{(</span><span class="n">NOCASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">CHARACTER</span><span class="p">,</span> <span class="p">(</span><span class="n">IGNORECASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
      <span class="n">OP</span><span class="o">.</span><span class="n">CHARACTER_IGN</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLCASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">CHARACTER</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLIGNORECASE</span><span class="p">,</span>
      <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">CHARACTER_IGN</span><span class="p">,</span> <span class="p">(</span><span class="n">NOCASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">CHARACTER_REV</span><span class="p">,</span> <span class="p">(</span><span class="n">IGNORECASE</span><span class="p">,</span>
      <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">CHARACTER_IGN_REV</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLCASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">CHARACTER_REV</span><span class="p">,</span>
      <span class="p">(</span><span class="n">FULLIGNORECASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">CHARACTER_IGN_REV</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">case_flags</span><span class="o">=</span><span class="n">NOCASE</span><span class="p">,</span>
      <span class="n">zerowidth</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">RegexBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positive</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">positive</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span> <span class="o">=</span> <span class="n">CASE_FLAGS_COMBINATIONS</span><span class="p">[</span><span class="n">case_flags</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zerowidth</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">zerowidth</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positive</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span> <span class="o">&amp;</span> <span class="n">FULLIGNORECASE</span><span class="p">)</span> <span class="o">==</span>
          <span class="n">FULLIGNORECASE</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">folded</span> <span class="o">=</span> <span class="n">_regex</span><span class="o">.</span><span class="n">fold_case</span><span class="p">(</span><span class="n">FULL_CASE_FOLDING</span><span class="p">,</span> <span class="nb">chr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">folded</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zerowidth</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rebuild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positive</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">,</span> <span class="n">zerowidth</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Character</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">positive</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">,</span> <span class="n">zerowidth</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">optimise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">in_set</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">get_firstset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">has_simple_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">POSITIVE_OP</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zerowidth</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">ZEROWIDTH_OP</span>
        <span class="k">if</span> <span class="n">fuzzy</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">FUZZY_OP</span>

        <span class="n">code</span> <span class="o">=</span> <span class="n">PrecompiledCode</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_opcode</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">,</span> <span class="n">reverse</span><span class="p">],</span> <span class="n">flags</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folded</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># The character expands on full case-folding.</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">Branch</span><span class="p">([</span><span class="n">code</span><span class="p">,</span> <span class="n">String</span><span class="p">([</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">folded</span><span class="p">],</span>
              <span class="n">case_flags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">code</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="n">display</span> <span class="o">=</span> <span class="n">ascii</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">))</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;bu&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">CHARACTER </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">,</span>
          <span class="n">POS_TEXT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">],</span> <span class="n">display</span><span class="p">,</span> <span class="n">CASE_TEXT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span>

    <span class="k">def</span> <span class="nf">max_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folded</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_required_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">folded_characters</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">folded</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span>

<span class="k">class</span> <span class="nc">Conditional</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">yes_item</span><span class="p">,</span> <span class="n">no_item</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="n">RegexBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span> <span class="o">=</span> <span class="n">yes_item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span> <span class="o">=</span> <span class="n">no_item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">position</span>

    <span class="k">def</span> <span class="nf">fix_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">group_index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;DEFINE&#39;</span><span class="p">:</span>
                    <span class="c1"># &#39;DEFINE&#39; is a special name unless there&#39;s a group with</span>
                    <span class="c1"># that name.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;unknown group&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">group_count</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;invalid group reference&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">fix_groups</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">fix_groups</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">optimise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="n">yes_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>
        <span class="n">no_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Conditional</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">,</span> <span class="n">yes_item</span><span class="p">,</span> <span class="n">no_item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pack_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">pack_characters</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">pack_characters</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">remove_captures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">remove_captures</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">remove_captures</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">is_atomic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">is_atomic</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">is_atomic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">can_be_affix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">can_be_affix</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">can_be_affix</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">contains_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">contains_group</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">contains_group</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_firstset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">get_firstset</span><span class="p">(</span><span class="n">reverse</span><span class="p">)</span> <span class="o">|</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">get_firstset</span><span class="p">(</span><span class="n">reverse</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="n">code</span> <span class="o">=</span> <span class="p">[(</span><span class="n">OP</span><span class="o">.</span><span class="n">GROUP_EXISTS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">)]</span>
        <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">))</span>
        <span class="n">add_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_code</span><span class="p">:</span>
            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">OP</span><span class="o">.</span><span class="n">NEXT</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">add_code</span><span class="p">)</span>

        <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">OP</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="p">))</span>

        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">GROUP_EXISTS </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">OR&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">group</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">yes_item</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">no_item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">max_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">max_width</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">max_width</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">DefaultBoundary</span><span class="p">(</span><span class="n">ZeroWidthBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">DEFAULT_BOUNDARY</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;DEFAULT_BOUNDARY&quot;</span>

<span class="k">class</span> <span class="nc">DefaultEndOfWord</span><span class="p">(</span><span class="n">ZeroWidthBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">DEFAULT_END_OF_WORD</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;DEFAULT_END_OF_WORD&quot;</span>

<span class="k">class</span> <span class="nc">DefaultStartOfWord</span><span class="p">(</span><span class="n">ZeroWidthBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">DEFAULT_START_OF_WORD</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;DEFAULT_START_OF_WORD&quot;</span>

<span class="k">class</span> <span class="nc">EndOfLine</span><span class="p">(</span><span class="n">ZeroWidthBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">END_OF_LINE</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;END_OF_LINE&quot;</span>

<span class="k">class</span> <span class="nc">EndOfLineU</span><span class="p">(</span><span class="n">EndOfLine</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">END_OF_LINE_U</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;END_OF_LINE_U&quot;</span>

<span class="k">class</span> <span class="nc">EndOfString</span><span class="p">(</span><span class="n">ZeroWidthBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">END_OF_STRING</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;END_OF_STRING&quot;</span>

<span class="k">class</span> <span class="nc">EndOfStringLine</span><span class="p">(</span><span class="n">ZeroWidthBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">END_OF_STRING_LINE</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;END_OF_STRING_LINE&quot;</span>

<span class="k">class</span> <span class="nc">EndOfStringLineU</span><span class="p">(</span><span class="n">EndOfStringLine</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">END_OF_STRING_LINE_U</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;END_OF_STRING_LINE_U&quot;</span>

<span class="k">class</span> <span class="nc">EndOfWord</span><span class="p">(</span><span class="n">ZeroWidthBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">END_OF_WORD</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;END_OF_WORD&quot;</span>

<span class="k">class</span> <span class="nc">Failure</span><span class="p">(</span><span class="n">ZeroWidthBase</span><span class="p">):</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;FAILURE&quot;</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">OP</span><span class="o">.</span><span class="n">FAILURE</span><span class="p">,</span> <span class="p">)]</span>

<span class="k">class</span> <span class="nc">Fuzzy</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subpattern</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">RegexBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">constraints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span> <span class="o">=</span> <span class="n">subpattern</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">constraints</span>

        <span class="c1"># If an error type is mentioned in the cost equation, then its maximum</span>
        <span class="c1"># defaults to unlimited.</span>
        <span class="k">if</span> <span class="s2">&quot;cost&quot;</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="s2">&quot;dis&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">]:</span>
                    <span class="n">constraints</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="c1"># If any error type is mentioned, then all the error maxima default to</span>
        <span class="c1"># 0, otherwise they default to unlimited.</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="s2">&quot;dis&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="s2">&quot;dis&quot;</span><span class="p">:</span>
                <span class="n">constraints</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="s2">&quot;dis&quot;</span><span class="p">:</span>
                <span class="n">constraints</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="c1"># The maximum of the generic error type defaults to unlimited.</span>
        <span class="n">constraints</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="c1"># The cost equation defaults to equal costs. Also, the cost of any</span>
        <span class="c1"># error type not mentioned in the cost equation defaults to 0.</span>
        <span class="k">if</span> <span class="s2">&quot;cost&quot;</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="s2">&quot;dis&quot;</span><span class="p">:</span>
                <span class="n">constraints</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">constraints</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
              <span class="n">constraints</span><span class="p">[</span><span class="s2">&quot;e&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]}</span>

    <span class="k">def</span> <span class="nf">fix_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">fix_groups</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pack_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">pack_characters</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">remove_captures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">remove_captures</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">is_atomic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">is_atomic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">contains_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">contains_group</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="c1"># The individual limits.</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="s2">&quot;dise&quot;</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
            <span class="n">arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UNLIMITED</span> <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># The coeffs of the cost equation.</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="s2">&quot;dis&quot;</span><span class="p">:</span>
            <span class="n">arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">][</span><span class="n">e</span><span class="p">])</span>

        <span class="c1"># The maximum of the cost equation.</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">][</span><span class="s2">&quot;max&quot;</span><span class="p">]</span>
        <span class="n">arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UNLIMITED</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">v</span><span class="p">)</span>

        <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">REVERSE_OP</span>

        <span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">test</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">([(</span><span class="n">OP</span><span class="o">.</span><span class="n">FUZZY_EXT</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">arguments</span><span class="p">)]</span> <span class="o">+</span>
              <span class="n">test</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="p">[(</span><span class="n">OP</span><span class="o">.</span><span class="n">NEXT</span><span class="p">,)]</span> <span class="o">+</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="p">[(</span><span class="n">OP</span><span class="o">.</span><span class="n">END</span><span class="p">,)])</span>

        <span class="k">return</span> <span class="p">([(</span><span class="n">OP</span><span class="o">.</span><span class="n">FUZZY</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">arguments</span><span class="p">)]</span> <span class="o">+</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="p">[(</span><span class="n">OP</span><span class="o">.</span><span class="n">END</span><span class="p">,)])</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints_to_string</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">constraints</span><span class="p">:</span>
            <span class="n">constraints</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">constraints</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">FUZZY</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">,</span> <span class="n">constraints</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span> <span class="o">==</span>
          <span class="n">other</span><span class="o">.</span><span class="n">subpattern</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">max_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">UNLIMITED</span>

    <span class="k">def</span> <span class="nf">_constraints_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="s2">&quot;ids&quot;</span><span class="p">:</span>
            <span class="nb">min</span><span class="p">,</span> <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">max</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">con</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">if</span> <span class="nb">min</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">con</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&lt;=&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">min</span><span class="p">)</span>

            <span class="n">con</span> <span class="o">+=</span> <span class="n">name</span>

            <span class="k">if</span> <span class="nb">max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">con</span> <span class="o">+=</span> <span class="s2">&quot;&lt;=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">max</span><span class="p">)</span>

            <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">con</span><span class="p">)</span>

        <span class="n">cost</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="s2">&quot;ids&quot;</span><span class="p">:</span>
            <span class="n">coeff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">coeff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

        <span class="n">limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">][</span><span class="s2">&quot;max&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&lt;=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cost</span><span class="p">),</span> <span class="n">limit</span><span class="p">)</span>
            <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Grapheme</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="c1"># Match at least 1 character until a grapheme boundary is reached. Note</span>
        <span class="c1"># that this is the same whether matching forwards or backwards.</span>
        <span class="n">grapheme_matcher</span> <span class="o">=</span> <span class="n">Atomic</span><span class="p">(</span><span class="n">Sequence</span><span class="p">([</span><span class="n">LazyRepeat</span><span class="p">(</span><span class="n">AnyAll</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
          <span class="n">GraphemeBoundary</span><span class="p">()]))</span>

        <span class="k">return</span> <span class="n">grapheme_matcher</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">GRAPHEME&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">max_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">UNLIMITED</span>

<span class="k">class</span> <span class="nc">GraphemeBoundary</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">OP</span><span class="o">.</span><span class="n">GRAPHEME_BOUNDARY</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>

<span class="k">class</span> <span class="nc">GreedyRepeat</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">GREEDY_REPEAT</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;GREEDY_REPEAT&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subpattern</span><span class="p">,</span> <span class="n">min_count</span><span class="p">,</span> <span class="n">max_count</span><span class="p">):</span>
        <span class="n">RegexBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span> <span class="o">=</span> <span class="n">subpattern</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_count</span> <span class="o">=</span> <span class="n">min_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_count</span> <span class="o">=</span> <span class="n">max_count</span>

    <span class="k">def</span> <span class="nf">fix_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">fix_groups</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">optimise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="n">subpattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">subpattern</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_count</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pack_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">pack_characters</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">remove_captures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">remove_captures</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">is_atomic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_count</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_count</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">is_atomic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">can_be_affix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">contains_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">contains_group</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_firstset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">get_firstset</span><span class="p">(</span><span class="n">reverse</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fs</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="n">repeat</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_opcode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_count</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">repeat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UNLIMITED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">repeat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_count</span><span class="p">)</span>

        <span class="n">subpattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subpattern</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="p">([</span><span class="nb">tuple</span><span class="p">(</span><span class="n">repeat</span><span class="p">)]</span> <span class="o">+</span> <span class="n">subpattern</span> <span class="o">+</span> <span class="p">[(</span><span class="n">OP</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="p">)])</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="s2">&quot;INF&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_count</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op_name</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">min_count</span><span class="p">,</span> <span class="n">limit</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_count</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">max_count</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">subpattern</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">min_count</span><span class="p">,</span>
          <span class="n">other</span><span class="o">.</span><span class="n">max_count</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">max_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">UNLIMITED</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">max_width</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_count</span>

    <span class="k">def</span> <span class="nf">get_required_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="n">max_count</span> <span class="o">=</span> <span class="n">UNLIMITED</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_count</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_count</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">max_width</span><span class="p">()</span> <span class="o">*</span> <span class="n">max_count</span>
            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">UNLIMITED</span><span class="p">),</span> <span class="kc">None</span>

        <span class="n">ofs</span><span class="p">,</span> <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">get_required_string</span><span class="p">(</span><span class="n">reverse</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">req</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">req</span>

        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">max_width</span><span class="p">()</span> <span class="o">*</span> <span class="n">max_count</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">UNLIMITED</span><span class="p">),</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">PossessiveRepeat</span><span class="p">(</span><span class="n">GreedyRepeat</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">is_atomic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="n">subpattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subpattern</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">repeat</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_opcode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_count</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">repeat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UNLIMITED</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">repeat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_count</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">([(</span><span class="n">OP</span><span class="o">.</span><span class="n">ATOMIC</span><span class="p">,</span> <span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">repeat</span><span class="p">)]</span> <span class="o">+</span> <span class="n">subpattern</span> <span class="o">+</span> <span class="p">[(</span><span class="n">OP</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="p">),</span>
          <span class="p">(</span><span class="n">OP</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="p">)])</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">ATOMIC&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_count</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="s2">&quot;INF&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_count</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op_name</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">min_count</span><span class="p">,</span> <span class="n">limit</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Group</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">subpattern</span><span class="p">):</span>
        <span class="n">RegexBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span> <span class="o">=</span> <span class="n">subpattern</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">call_ref</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">fix_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">defined_groups</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">fix_groups</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">optimise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="n">subpattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">,</span> <span class="n">subpattern</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pack_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">pack_characters</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">remove_captures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">remove_captures</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">is_atomic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">is_atomic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">can_be_affix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">contains_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_firstset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">get_firstset</span><span class="p">(</span><span class="n">reverse</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_simple_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">has_simple_start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">public_group</span> <span class="o">=</span> <span class="n">private_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span>
        <span class="k">if</span> <span class="n">private_group</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">public_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">private_groups</span><span class="p">[</span><span class="n">private_group</span><span class="p">]</span>
            <span class="n">private_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">group_count</span> <span class="o">-</span> <span class="n">private_group</span>

        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">call_refs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">OP</span><span class="o">.</span><span class="n">CALL_REF</span><span class="p">,</span> <span class="n">ref</span><span class="p">)]</span>

        <span class="n">code</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">OP</span><span class="o">.</span><span class="n">GROUP</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="ow">not</span> <span class="n">reverse</span><span class="p">),</span> <span class="n">private_group</span><span class="p">,</span> <span class="n">public_group</span><span class="p">)]</span>
        <span class="n">code</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">OP</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="p">)]</span>

        <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">OP</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="p">)]</span>

        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span>
        <span class="k">if</span> <span class="n">group</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">private_groups</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">GROUP </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">,</span> <span class="n">group</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="p">)</span> <span class="o">==</span>
          <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">group</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">subpattern</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">max_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">max_width</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_required_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">get_required_string</span><span class="p">(</span><span class="n">reverse</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">Keep</span><span class="p">(</span><span class="n">ZeroWidthBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">KEEP</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;KEEP&quot;</span>

<span class="k">class</span> <span class="nc">LazyRepeat</span><span class="p">(</span><span class="n">GreedyRepeat</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">LAZY_REPEAT</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;LAZY_REPEAT&quot;</span>

<span class="k">class</span> <span class="nc">LookAround</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="n">_dir_text</span> <span class="o">=</span> <span class="p">{</span><span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;AHEAD&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">:</span> <span class="s2">&quot;BEHIND&quot;</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">behind</span><span class="p">,</span> <span class="n">positive</span><span class="p">,</span> <span class="n">subpattern</span><span class="p">):</span>
        <span class="n">RegexBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behind</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">behind</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positive</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">positive</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span> <span class="o">=</span> <span class="n">subpattern</span>

    <span class="k">def</span> <span class="nf">fix_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">fix_groups</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">behind</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">optimise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="n">subpattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">behind</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span> <span class="ow">and</span> <span class="n">subpattern</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">subpattern</span>

        <span class="k">return</span> <span class="n">LookAround</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">subpattern</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pack_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">pack_characters</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">remove_captures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">remove_captures</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">is_atomic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">is_atomic</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">can_be_affix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">can_be_affix</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">contains_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">contains_group</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_firstset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">behind</span> <span class="o">==</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">get_firstset</span><span class="p">(</span><span class="n">reverse</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">set</span><span class="p">([</span><span class="kc">None</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">POSITIVE_OP</span>
        <span class="k">if</span> <span class="n">fuzzy</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">FUZZY_OP</span>
        <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">REVERSE_OP</span>

        <span class="k">return</span> <span class="p">([(</span><span class="n">OP</span><span class="o">.</span><span class="n">LOOKAROUND</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">behind</span><span class="p">))]</span> <span class="o">+</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behind</span><span class="p">)</span> <span class="o">+</span> <span class="p">[(</span><span class="n">OP</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="p">)])</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">LOOK</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_dir_text</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">behind</span><span class="p">],</span> <span class="n">POS_TEXT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">behind</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">behind</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">subpattern</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">max_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>

<span class="k">class</span> <span class="nc">LookAroundConditional</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="n">_dir_text</span> <span class="o">=</span> <span class="p">{</span><span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;AHEAD&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">:</span> <span class="s2">&quot;BEHIND&quot;</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">behind</span><span class="p">,</span> <span class="n">positive</span><span class="p">,</span> <span class="n">subpattern</span><span class="p">,</span> <span class="n">yes_item</span><span class="p">,</span> <span class="n">no_item</span><span class="p">):</span>
        <span class="n">RegexBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">behind</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">behind</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positive</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">positive</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span> <span class="o">=</span> <span class="n">subpattern</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span> <span class="o">=</span> <span class="n">yes_item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span> <span class="o">=</span> <span class="n">no_item</span>

    <span class="k">def</span> <span class="nf">fix_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">fix_groups</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">fix_groups</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">fix_groups</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">optimise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="n">subpattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">behind</span><span class="p">)</span>
        <span class="n">yes_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">behind</span><span class="p">)</span>
        <span class="n">no_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">behind</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">LookAroundConditional</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span> <span class="n">subpattern</span><span class="p">,</span>
          <span class="n">yes_item</span><span class="p">,</span> <span class="n">no_item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pack_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">pack_characters</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">pack_characters</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">pack_characters</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">remove_captures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">remove_captures</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">remove_captures</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">remove_captures</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">is_atomic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">is_atomic</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">is_atomic</span><span class="p">()</span> <span class="ow">and</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">is_atomic</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">can_be_affix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">can_be_affix</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">can_be_affix</span><span class="p">()</span>
          <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">can_be_affix</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">contains_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">contains_group</span><span class="p">()</span> <span class="ow">or</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">contains_group</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">contains_group</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="n">code</span> <span class="o">=</span> <span class="p">[(</span><span class="n">OP</span><span class="o">.</span><span class="n">CONDITIONAL</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">behind</span><span class="p">))]</span>
        <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">behind</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">))</span>
        <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">OP</span><span class="o">.</span><span class="n">NEXT</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">))</span>
        <span class="n">add_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_code</span><span class="p">:</span>
            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">OP</span><span class="o">.</span><span class="n">NEXT</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">add_code</span><span class="p">)</span>

        <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">OP</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="p">))</span>

        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">CONDITIONAL </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_dir_text</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">behind</span><span class="p">],</span> <span class="n">POS_TEXT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">behind</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">EITHER&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">OR&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="ow">or</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">is_empty</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subpattern</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">subpattern</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">yes_item</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">no_item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">max_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yes_item</span><span class="o">.</span><span class="n">max_width</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_item</span><span class="o">.</span><span class="n">max_width</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">get_required_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_width</span><span class="p">(),</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">PrecompiledCode</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">)]</span>

<span class="k">class</span> <span class="nc">Property</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="p">{(</span><span class="n">NOCASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">PROPERTY</span><span class="p">,</span> <span class="p">(</span><span class="n">IGNORECASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
      <span class="n">OP</span><span class="o">.</span><span class="n">PROPERTY_IGN</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLCASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">PROPERTY</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLIGNORECASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
      <span class="n">OP</span><span class="o">.</span><span class="n">PROPERTY_IGN</span><span class="p">,</span> <span class="p">(</span><span class="n">NOCASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">PROPERTY_REV</span><span class="p">,</span> <span class="p">(</span><span class="n">IGNORECASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
      <span class="n">OP</span><span class="o">.</span><span class="n">PROPERTY_IGN_REV</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLCASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">PROPERTY_REV</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLIGNORECASE</span><span class="p">,</span>
      <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">PROPERTY_IGN_REV</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">case_flags</span><span class="o">=</span><span class="n">NOCASE</span><span class="p">,</span>
      <span class="n">zerowidth</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">RegexBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positive</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">positive</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span> <span class="o">=</span> <span class="n">CASE_FLAGS_COMBINATIONS</span><span class="p">[</span><span class="n">case_flags</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zerowidth</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">zerowidth</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zerowidth</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rebuild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positive</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">,</span> <span class="n">zerowidth</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Property</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">positive</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">,</span> <span class="n">zerowidth</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">optimise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">in_set</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">get_firstset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">has_simple_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">POSITIVE_OP</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zerowidth</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">ZEROWIDTH_OP</span>
        <span class="k">if</span> <span class="n">fuzzy</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">FUZZY_OP</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_opcode</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">,</span> <span class="n">reverse</span><span class="p">],</span> <span class="n">flags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="n">PROPERTY_NAMES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">]</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">prop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">prop</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">PROPERTY </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">:</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">,</span>
          <span class="n">POS_TEXT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">CASE_TEXT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_regex</span><span class="o">.</span><span class="n">has_property_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span>

    <span class="k">def</span> <span class="nf">max_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>

<span class="k">class</span> <span class="nc">Prune</span><span class="p">(</span><span class="n">ZeroWidthBase</span><span class="p">):</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;PRUNE&quot;</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">OP</span><span class="o">.</span><span class="n">PRUNE</span><span class="p">,</span> <span class="p">)]</span>

<span class="k">class</span> <span class="nc">Range</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="p">{(</span><span class="n">NOCASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">RANGE</span><span class="p">,</span> <span class="p">(</span><span class="n">IGNORECASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">RANGE_IGN</span><span class="p">,</span>
      <span class="p">(</span><span class="n">FULLCASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">RANGE</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLIGNORECASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">RANGE_IGN</span><span class="p">,</span>
      <span class="p">(</span><span class="n">NOCASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">RANGE_REV</span><span class="p">,</span> <span class="p">(</span><span class="n">IGNORECASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">RANGE_IGN_REV</span><span class="p">,</span>
      <span class="p">(</span><span class="n">FULLCASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">RANGE_REV</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLIGNORECASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">RANGE_IGN_REV</span><span class="p">}</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;RANGE&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">case_flags</span><span class="o">=</span><span class="n">NOCASE</span><span class="p">,</span>
      <span class="n">zerowidth</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">RegexBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower</span> <span class="o">=</span> <span class="n">lower</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upper</span> <span class="o">=</span> <span class="n">upper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positive</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">positive</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span> <span class="o">=</span> <span class="n">CASE_FLAGS_COMBINATIONS</span><span class="p">[</span><span class="n">case_flags</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zerowidth</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">zerowidth</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zerowidth</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rebuild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positive</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">,</span> <span class="n">zerowidth</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">positive</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">,</span> <span class="n">zerowidth</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">optimise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">in_set</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Is the range case-sensitive?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span> <span class="o">&amp;</span> <span class="n">IGNORECASE</span><span class="p">)</span> <span class="ow">or</span> <span class="n">in_set</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># Is full case-folding possible?</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UNICODE</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span> <span class="o">&amp;</span> <span class="n">FULLIGNORECASE</span><span class="p">)</span> <span class="o">!=</span>
          <span class="n">FULLIGNORECASE</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># Get the characters which expand to multiple codepoints on folding.</span>
        <span class="n">expanding_chars</span> <span class="o">=</span> <span class="n">_regex</span><span class="o">.</span><span class="n">get_expand_on_folding</span><span class="p">()</span>

        <span class="c1"># Get the folded characters in the range.</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expanding_chars</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span> <span class="o">&lt;=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">:</span>
                <span class="n">folded</span> <span class="o">=</span> <span class="n">_regex</span><span class="o">.</span><span class="n">fold_case</span><span class="p">(</span><span class="n">FULL_CASE_FOLDING</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">String</span><span class="p">([</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">folded</span><span class="p">],</span>
                  <span class="n">case_flags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
            <span class="c1"># We can fall back to simple case-folding.</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Not all the characters are covered by the full case-folding.</span>
            <span class="n">items</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Branch</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">POSITIVE_OP</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zerowidth</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">ZEROWIDTH_OP</span>
        <span class="k">if</span> <span class="n">fuzzy</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">FUZZY_OP</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_opcode</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">,</span> <span class="n">reverse</span><span class="p">],</span> <span class="n">flags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="n">display_lower</span> <span class="o">=</span> <span class="n">ascii</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">))</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;bu&quot;</span><span class="p">)</span>
        <span class="n">display_upper</span> <span class="o">=</span> <span class="n">ascii</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">))</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;bu&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">RANGE </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">,</span>
          <span class="n">POS_TEXT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">],</span> <span class="n">display_lower</span><span class="p">,</span> <span class="n">display_upper</span><span class="p">,</span>
          <span class="n">CASE_TEXT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span>

    <span class="k">def</span> <span class="nf">max_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>

<span class="k">class</span> <span class="nc">RefGroup</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="p">{(</span><span class="n">NOCASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">REF_GROUP</span><span class="p">,</span> <span class="p">(</span><span class="n">IGNORECASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
      <span class="n">OP</span><span class="o">.</span><span class="n">REF_GROUP_IGN</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLCASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">REF_GROUP</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLIGNORECASE</span><span class="p">,</span>
      <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">REF_GROUP_FLD</span><span class="p">,</span> <span class="p">(</span><span class="n">NOCASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">REF_GROUP_REV</span><span class="p">,</span> <span class="p">(</span><span class="n">IGNORECASE</span><span class="p">,</span>
      <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">REF_GROUP_IGN_REV</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLCASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">REF_GROUP_REV</span><span class="p">,</span>
      <span class="p">(</span><span class="n">FULLIGNORECASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">REF_GROUP_FLD_REV</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">case_flags</span><span class="o">=</span><span class="n">NOCASE</span><span class="p">):</span>
        <span class="n">RegexBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span> <span class="o">=</span> <span class="n">CASE_FLAGS_COMBINATIONS</span><span class="p">[</span><span class="n">case_flags</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span>

    <span class="k">def</span> <span class="nf">fix_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">group_index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;unknown group&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">group_count</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;invalid group reference&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span>

    <span class="k">def</span> <span class="nf">remove_captures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;group reference not allowed&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">fuzzy</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">FUZZY_OP</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_opcode</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">,</span> <span class="n">reverse</span><span class="p">],</span> <span class="n">flags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">REF_GROUP </span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">,</span>
          <span class="n">CASE_TEXT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">max_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">UNLIMITED</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">SearchAnchor</span><span class="p">(</span><span class="n">ZeroWidthBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">SEARCH_ANCHOR</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;SEARCH_ANCHOR&quot;</span>

<span class="k">class</span> <span class="nc">Sequence</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">RegexBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">items</span>

    <span class="k">def</span> <span class="nf">fix_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">fix_groups</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">optimise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="c1"># Flatten the sequences.</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
                <span class="n">items</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">make_sequence</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pack_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="s2">&quot;Packs sequences of characters into strings.&quot;</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">characters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">case_flags</span> <span class="o">=</span> <span class="n">NOCASE</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Character</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">positive</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">zerowidth</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">case_flags</span> <span class="o">!=</span> <span class="n">case_flags</span><span class="p">:</span>
                    <span class="c1"># Different case sensitivity, so flush, unless neither the</span>
                    <span class="c1"># previous nor the new character are cased.</span>
                    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">case_flags</span> <span class="ow">or</span> <span class="n">is_cased_i</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
                        <span class="n">Sequence</span><span class="o">.</span><span class="n">_flush_characters</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">characters</span><span class="p">,</span>
                          <span class="n">case_flags</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>

                        <span class="n">case_flags</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">case_flags</span>

                <span class="n">characters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">is</span> <span class="n">String</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Literal</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">case_flags</span> <span class="o">!=</span> <span class="n">case_flags</span><span class="p">:</span>
                    <span class="c1"># Different case sensitivity, so flush, unless the neither</span>
                    <span class="c1"># the previous nor the new string are cased.</span>
                    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">case_flags</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">is_cased_i</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span>
                      <span class="n">characters</span><span class="p">):</span>
                        <span class="n">Sequence</span><span class="o">.</span><span class="n">_flush_characters</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">characters</span><span class="p">,</span>
                          <span class="n">case_flags</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>

                        <span class="n">case_flags</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">case_flags</span>

                <span class="n">characters</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">characters</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Sequence</span><span class="o">.</span><span class="n">_flush_characters</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">characters</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>

                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">pack_characters</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>

        <span class="n">Sequence</span><span class="o">.</span><span class="n">_flush_characters</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">characters</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">make_sequence</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_captures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">remove_captures</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">is_atomic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">is_atomic</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">can_be_affix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">contains_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">contains_group</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_firstset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span>
        <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">fs</span> <span class="o">|=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_firstset</span><span class="p">(</span><span class="n">reverse</span><span class="p">)</span>
            <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fs</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fs</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fs</span> <span class="o">|</span> <span class="nb">set</span><span class="p">([</span><span class="kc">None</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">has_simple_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">has_simple_start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span>
        <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">:</span>
            <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_flush_characters</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">characters</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">characters</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Disregard case_flags if all of the characters are case-less.</span>
        <span class="k">if</span> <span class="n">case_flags</span> <span class="o">&amp;</span> <span class="n">IGNORECASE</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">is_cased_i</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">characters</span><span class="p">):</span>
                <span class="n">case_flags</span> <span class="o">=</span> <span class="n">NOCASE</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">case_flags</span> <span class="o">&amp;</span> <span class="n">FULLIGNORECASE</span><span class="p">)</span> <span class="o">==</span> <span class="n">FULLIGNORECASE</span><span class="p">:</span>
            <span class="n">literals</span> <span class="o">=</span> <span class="n">Sequence</span><span class="o">.</span><span class="n">_fix_full_casefold</span><span class="p">(</span><span class="n">characters</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">literals</span><span class="p">:</span>
                <span class="n">chars</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">characters</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Character</span><span class="p">(</span><span class="n">chars</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">case_flags</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">case_flags</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">chars</span><span class="p">,</span> <span class="n">case_flags</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">case_flags</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">characters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Character</span><span class="p">(</span><span class="n">characters</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">case_flags</span><span class="o">=</span><span class="n">case_flags</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="n">characters</span><span class="p">,</span> <span class="n">case_flags</span><span class="o">=</span><span class="n">case_flags</span><span class="p">))</span>

        <span class="n">characters</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_fix_full_casefold</span><span class="p">(</span><span class="n">characters</span><span class="p">):</span>
        <span class="c1"># Split a literal needing full case-folding into chunks that need it</span>
        <span class="c1"># and chunks that can use simple case-folding, which is faster.</span>
        <span class="n">expanded</span> <span class="o">=</span> <span class="p">[</span><span class="n">_regex</span><span class="o">.</span><span class="n">fold_case</span><span class="p">(</span><span class="n">FULL_CASE_FOLDING</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span>
          <span class="n">_regex</span><span class="o">.</span><span class="n">get_expand_on_folding</span><span class="p">()]</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">_regex</span><span class="o">.</span><span class="n">fold_case</span><span class="p">(</span><span class="n">FULL_CASE_FOLDING</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
          <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">characters</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">expanded</span><span class="p">:</span>
            <span class="n">found</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">found</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">found</span><span class="p">,</span> <span class="n">found</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="n">found</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">found</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">literals</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">Sequence</span><span class="o">.</span><span class="n">_merge_chunks</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">:</span>
                <span class="n">literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Literal</span><span class="p">(</span><span class="n">characters</span><span class="p">[</span><span class="n">pos</span> <span class="p">:</span> <span class="n">start</span><span class="p">],</span>
                  <span class="n">case_flags</span><span class="o">=</span><span class="n">IGNORECASE</span><span class="p">))</span>

            <span class="n">literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Literal</span><span class="p">(</span><span class="n">characters</span><span class="p">[</span><span class="n">start</span> <span class="p">:</span> <span class="n">end</span><span class="p">],</span>
              <span class="n">case_flags</span><span class="o">=</span><span class="n">FULLIGNORECASE</span><span class="p">))</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">end</span>

        <span class="k">if</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">characters</span><span class="p">):</span>
            <span class="n">literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Literal</span><span class="p">(</span><span class="n">characters</span><span class="p">[</span><span class="n">pos</span> <span class="p">:</span> <span class="p">],</span> <span class="n">case_flags</span><span class="o">=</span><span class="n">IGNORECASE</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">literals</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_merge_chunks</span><span class="p">(</span><span class="n">chunks</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">chunks</span>

        <span class="n">chunks</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">new_chunks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="p">]:</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span>

        <span class="n">new_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">new_chunks</span>

    <span class="k">def</span> <span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">items</span>

    <span class="k">def</span> <span class="nf">max_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">max_width</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_required_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span>
        <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">:</span>
            <span class="n">ofs</span><span class="p">,</span> <span class="n">req</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_required_string</span><span class="p">(</span><span class="n">reverse</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">ofs</span>
            <span class="k">if</span> <span class="n">req</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">offset</span><span class="p">,</span> <span class="n">req</span>

        <span class="k">return</span> <span class="n">offset</span><span class="p">,</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">SetBase</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">case_flags</span><span class="o">=</span><span class="n">NOCASE</span><span class="p">,</span>
      <span class="n">zerowidth</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">RegexBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positive</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">positive</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span> <span class="o">=</span> <span class="n">CASE_FLAGS_COMBINATIONS</span><span class="p">[</span><span class="n">case_flags</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zerowidth</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">zerowidth</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">char_width</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">zerowidth</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rebuild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positive</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">,</span> <span class="n">zerowidth</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">,</span> <span class="n">positive</span><span class="p">,</span> <span class="n">case_flags</span><span class="p">,</span>
          <span class="n">zerowidth</span><span class="p">)</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_firstset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">([</span><span class="bp">self</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">has_simple_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">POSITIVE_OP</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zerowidth</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">ZEROWIDTH_OP</span>
        <span class="k">if</span> <span class="n">fuzzy</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">FUZZY_OP</span>
        <span class="n">code</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_opcode</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">,</span> <span class="n">reverse</span><span class="p">],</span> <span class="n">flags</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">compile</span><span class="p">())</span>

        <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">OP</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="p">))</span>

        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2"> </span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op_name</span><span class="p">,</span>
          <span class="n">POS_TEXT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">],</span> <span class="n">CASE_TEXT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="n">i</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_handle_case_folding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">in_set</span><span class="p">):</span>
        <span class="c1"># Is the set case-sensitive?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span> <span class="o">&amp;</span> <span class="n">IGNORECASE</span><span class="p">)</span> <span class="ow">or</span> <span class="n">in_set</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># Is full case-folding possible?</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UNICODE</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span> <span class="o">&amp;</span>
          <span class="n">FULLIGNORECASE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FULLIGNORECASE</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># Get the characters which expand to multiple codepoints on folding.</span>
        <span class="n">expanding_chars</span> <span class="o">=</span> <span class="n">_regex</span><span class="o">.</span><span class="n">get_expand_on_folding</span><span class="p">()</span>

        <span class="c1"># Get the folded characters in the set.</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expanding_chars</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">)):</span>
                <span class="n">folded</span> <span class="o">=</span> <span class="n">_regex</span><span class="o">.</span><span class="n">fold_case</span><span class="p">(</span><span class="n">FULL_CASE_FOLDING</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">folded</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                    <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">String</span><span class="p">([</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">folded</span><span class="p">],</span>
                      <span class="n">case_flags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">))</span>
                    <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">folded</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
            <span class="c1"># We can fall back to simple case-folding.</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">return</span> <span class="n">Branch</span><span class="p">([</span><span class="bp">self</span><span class="p">]</span> <span class="o">+</span> <span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">max_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Is the set case-sensitive?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span> <span class="o">&amp;</span> <span class="n">IGNORECASE</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="c1"># Is full case-folding possible?</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UNICODE</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span> <span class="o">&amp;</span>
          <span class="n">FULLIGNORECASE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FULLIGNORECASE</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="c1"># Get the characters which expand to multiple codepoints on folding.</span>
        <span class="n">expanding_chars</span> <span class="o">=</span> <span class="n">_regex</span><span class="o">.</span><span class="n">get_expand_on_folding</span><span class="p">()</span>

        <span class="c1"># Get the folded characters in the set.</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">expanding_chars</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">)):</span>
                <span class="n">folded</span> <span class="o">=</span> <span class="n">_regex</span><span class="o">.</span><span class="n">fold_case</span><span class="p">(</span><span class="n">FULL_CASE_FOLDING</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">folded</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">seen</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">folded</span><span class="p">)</span> <span class="k">for</span> <span class="n">folded</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">SetDiff</span><span class="p">(</span><span class="n">SetBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="p">{(</span><span class="n">NOCASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_DIFF</span><span class="p">,</span> <span class="p">(</span><span class="n">IGNORECASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
      <span class="n">OP</span><span class="o">.</span><span class="n">SET_DIFF_IGN</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLCASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_DIFF</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLIGNORECASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
      <span class="n">OP</span><span class="o">.</span><span class="n">SET_DIFF_IGN</span><span class="p">,</span> <span class="p">(</span><span class="n">NOCASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_DIFF_REV</span><span class="p">,</span> <span class="p">(</span><span class="n">IGNORECASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
      <span class="n">OP</span><span class="o">.</span><span class="n">SET_DIFF_IGN_REV</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLCASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_DIFF_REV</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLIGNORECASE</span><span class="p">,</span>
      <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_DIFF_IGN_REV</span><span class="p">}</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;SET_DIFF&quot;</span>

    <span class="k">def</span> <span class="nf">optimise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">in_set</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SetUnion</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="p">])]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">with_flags</span><span class="p">(</span><span class="n">case_flags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">,</span>
              <span class="n">zerowidth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zerowidth</span><span class="p">)</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">in_set</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">in_set</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span>
          <span class="n">items</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_case_folding</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">in_set</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span>

<span class="k">class</span> <span class="nc">SetInter</span><span class="p">(</span><span class="n">SetBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="p">{(</span><span class="n">NOCASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_INTER</span><span class="p">,</span> <span class="p">(</span><span class="n">IGNORECASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
      <span class="n">OP</span><span class="o">.</span><span class="n">SET_INTER_IGN</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLCASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_INTER</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLIGNORECASE</span><span class="p">,</span>
      <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_INTER_IGN</span><span class="p">,</span> <span class="p">(</span><span class="n">NOCASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_INTER_REV</span><span class="p">,</span> <span class="p">(</span><span class="n">IGNORECASE</span><span class="p">,</span>
      <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_INTER_IGN_REV</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLCASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_INTER_REV</span><span class="p">,</span>
      <span class="p">(</span><span class="n">FULLIGNORECASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_INTER_IGN_REV</span><span class="p">}</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;SET_INTER&quot;</span>

    <span class="k">def</span> <span class="nf">optimise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">in_set</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">in_set</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">SetInter</span><span class="p">)</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">positive</span><span class="p">:</span>
                <span class="c1"># Intersection in intersection.</span>
                <span class="n">items</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">with_flags</span><span class="p">(</span><span class="n">case_flags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">,</span>
              <span class="n">zerowidth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zerowidth</span><span class="p">)</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">in_set</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_case_folding</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">in_set</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span>

<span class="k">class</span> <span class="nc">SetSymDiff</span><span class="p">(</span><span class="n">SetBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="p">{(</span><span class="n">NOCASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_SYM_DIFF</span><span class="p">,</span> <span class="p">(</span><span class="n">IGNORECASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
      <span class="n">OP</span><span class="o">.</span><span class="n">SET_SYM_DIFF_IGN</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLCASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_SYM_DIFF</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLIGNORECASE</span><span class="p">,</span>
      <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_SYM_DIFF_IGN</span><span class="p">,</span> <span class="p">(</span><span class="n">NOCASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_SYM_DIFF_REV</span><span class="p">,</span>
      <span class="p">(</span><span class="n">IGNORECASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_SYM_DIFF_IGN_REV</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLCASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
      <span class="n">OP</span><span class="o">.</span><span class="n">SET_SYM_DIFF_REV</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLIGNORECASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_SYM_DIFF_IGN_REV</span><span class="p">}</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;SET_SYM_DIFF&quot;</span>

    <span class="k">def</span> <span class="nf">optimise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">in_set</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">in_set</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">SetSymDiff</span><span class="p">)</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">positive</span><span class="p">:</span>
                <span class="c1"># Symmetric difference in symmetric difference.</span>
                <span class="n">items</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">with_flags</span><span class="p">(</span><span class="n">case_flags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">,</span>
              <span class="n">zerowidth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zerowidth</span><span class="p">)</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">in_set</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_case_folding</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">in_set</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">!=</span> <span class="n">i</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">m</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span>

<span class="k">class</span> <span class="nc">SetUnion</span><span class="p">(</span><span class="n">SetBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="p">{(</span><span class="n">NOCASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_UNION</span><span class="p">,</span> <span class="p">(</span><span class="n">IGNORECASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
      <span class="n">OP</span><span class="o">.</span><span class="n">SET_UNION_IGN</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLCASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_UNION</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLIGNORECASE</span><span class="p">,</span>
      <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_UNION_IGN</span><span class="p">,</span> <span class="p">(</span><span class="n">NOCASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_UNION_REV</span><span class="p">,</span> <span class="p">(</span><span class="n">IGNORECASE</span><span class="p">,</span>
      <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_UNION_IGN_REV</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLCASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_UNION_REV</span><span class="p">,</span>
      <span class="p">(</span><span class="n">FULLIGNORECASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">SET_UNION_IGN_REV</span><span class="p">}</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;SET_UNION&quot;</span>

    <span class="k">def</span> <span class="nf">optimise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">in_set</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">in_set</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">SetUnion</span><span class="p">)</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">positive</span><span class="p">:</span>
                <span class="c1"># Union in union.</span>
                <span class="n">items</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">i</span><span class="o">.</span><span class="n">with_flags</span><span class="p">(</span><span class="n">positive</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">positive</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span>
              <span class="n">case_flags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">,</span>
              <span class="n">zerowidth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zerowidth</span><span class="p">)</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">in_set</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_case_folding</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">in_set</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">POSITIVE_OP</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zerowidth</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">ZEROWIDTH_OP</span>
        <span class="k">if</span> <span class="n">fuzzy</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">FUZZY_OP</span>

        <span class="n">characters</span><span class="p">,</span> <span class="n">others</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">),</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">Character</span><span class="p">):</span>
                <span class="n">characters</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">positive</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">others</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="n">code</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_opcode</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">,</span> <span class="n">reverse</span><span class="p">],</span> <span class="n">flags</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">positive</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">characters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">positive</span><span class="p">:</span>
                <span class="n">flags</span> <span class="o">|=</span> <span class="n">POSITIVE_OP</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">OP</span><span class="o">.</span><span class="n">CHARACTER</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">OP</span><span class="o">.</span><span class="n">STRING</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">))</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">others</span><span class="p">:</span>
            <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">compile</span><span class="p">())</span>

        <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">OP</span><span class="o">.</span><span class="n">END</span><span class="p">,</span> <span class="p">))</span>

        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">positive</span>

<span class="k">class</span> <span class="nc">Skip</span><span class="p">(</span><span class="n">ZeroWidthBase</span><span class="p">):</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;SKIP&quot;</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">SKIP</span>

<span class="k">class</span> <span class="nc">StartOfLine</span><span class="p">(</span><span class="n">ZeroWidthBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">START_OF_LINE</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;START_OF_LINE&quot;</span>

<span class="k">class</span> <span class="nc">StartOfLineU</span><span class="p">(</span><span class="n">StartOfLine</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">START_OF_LINE_U</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;START_OF_LINE_U&quot;</span>

<span class="k">class</span> <span class="nc">StartOfString</span><span class="p">(</span><span class="n">ZeroWidthBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">START_OF_STRING</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;START_OF_STRING&quot;</span>

<span class="k">class</span> <span class="nc">StartOfWord</span><span class="p">(</span><span class="n">ZeroWidthBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="n">OP</span><span class="o">.</span><span class="n">START_OF_WORD</span>
    <span class="n">_op_name</span> <span class="o">=</span> <span class="s2">&quot;START_OF_WORD&quot;</span>

<span class="k">class</span> <span class="nc">String</span><span class="p">(</span><span class="n">RegexBase</span><span class="p">):</span>
    <span class="n">_opcode</span> <span class="o">=</span> <span class="p">{(</span><span class="n">NOCASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">STRING</span><span class="p">,</span> <span class="p">(</span><span class="n">IGNORECASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">STRING_IGN</span><span class="p">,</span>
      <span class="p">(</span><span class="n">FULLCASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">STRING</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLIGNORECASE</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">STRING_FLD</span><span class="p">,</span>
      <span class="p">(</span><span class="n">NOCASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">STRING_REV</span><span class="p">,</span> <span class="p">(</span><span class="n">IGNORECASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">STRING_IGN_REV</span><span class="p">,</span>
      <span class="p">(</span><span class="n">FULLCASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="n">OP</span><span class="o">.</span><span class="n">STRING_REV</span><span class="p">,</span> <span class="p">(</span><span class="n">FULLIGNORECASE</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
      <span class="n">OP</span><span class="o">.</span><span class="n">STRING_FLD_REV</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">characters</span><span class="p">,</span> <span class="n">case_flags</span><span class="o">=</span><span class="n">NOCASE</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">characters</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">characters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span> <span class="o">=</span> <span class="n">CASE_FLAGS_COMBINATIONS</span><span class="p">[</span><span class="n">case_flags</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span> <span class="o">&amp;</span> <span class="n">FULLIGNORECASE</span><span class="p">)</span> <span class="o">==</span> <span class="n">FULLIGNORECASE</span><span class="p">:</span>
            <span class="n">folded_characters</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">characters</span><span class="p">:</span>
                <span class="n">folded</span> <span class="o">=</span> <span class="n">_regex</span><span class="o">.</span><span class="n">fold_case</span><span class="p">(</span><span class="n">FULL_CASE_FOLDING</span><span class="p">,</span> <span class="nb">chr</span><span class="p">(</span><span class="n">char</span><span class="p">))</span>
                <span class="n">folded_characters</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">folded</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">folded_characters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">characters</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">folded_characters</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">folded_characters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">characters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span>

    <span class="k">def</span> <span class="nf">get_firstset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">([</span><span class="n">Character</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">characters</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span>
          <span class="n">case_flags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">has_simple_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">fuzzy</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">FUZZY_OP</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">required</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">REQUIRED_OP</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_opcode</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">,</span> <span class="n">reverse</span><span class="p">],</span> <span class="n">flags</span><span class="p">,</span>
          <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folded_characters</span><span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">folded_characters</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="n">display</span> <span class="o">=</span> <span class="n">ascii</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">characters</span><span class="p">))</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;bu&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">STRING </span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">,</span> <span class="n">display</span><span class="p">,</span>
          <span class="n">CASE_TEXT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">max_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folded_characters</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_required_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span>

<span class="k">class</span> <span class="nc">Literal</span><span class="p">(</span><span class="n">String</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="n">literal</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">characters</span><span class="p">)</span>
        <span class="n">display</span> <span class="o">=</span> <span class="n">ascii</span><span class="p">(</span><span class="n">literal</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;bu&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">LITERAL MATCH </span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">,</span> <span class="n">display</span><span class="p">,</span>
          <span class="n">CASE_TEXT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">]))</span>

<span class="k">class</span> <span class="nc">StringSet</span><span class="p">(</span><span class="n">Branch</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">case_flags</span><span class="o">=</span><span class="n">NOCASE</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span> <span class="o">=</span> <span class="n">CASE_FLAGS_COMBINATIONS</span><span class="p">[</span><span class="n">case_flags</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">named_lists_used</span><span class="p">:</span>
            <span class="n">info</span><span class="o">.</span><span class="n">named_lists_used</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">set_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">named_lists_used</span><span class="p">)</span>

        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">named_lists_used</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">set_key</span><span class="p">]</span>
        <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

        <span class="n">case_flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span>

        <span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">_ALL_ENCODINGS</span>
        <span class="n">fold_flags</span> <span class="o">=</span> <span class="n">encoding</span> <span class="o">|</span> <span class="n">case_flags</span>

        <span class="n">choices</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">string</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">string</span> <span class="o">=</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="p">]</span>

            <span class="n">choices</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">Character</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">case_flags</span><span class="o">=</span><span class="n">case_flags</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span>
              <span class="n">string</span><span class="p">])</span>

        <span class="c1"># Sort from longest to shortest.</span>
        <span class="n">choices</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">branches</span> <span class="o">=</span> <span class="p">[</span><span class="n">Sequence</span><span class="p">(</span><span class="n">choice</span><span class="p">)</span> <span class="k">for</span> <span class="n">choice</span> <span class="ow">in</span> <span class="n">choices</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">STRING_SET </span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">INDENT</span> <span class="o">*</span> <span class="n">indent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
          <span class="n">CASE_TEXT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">case_flags</span><span class="p">]))</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">Source</span><span class="p">:</span>
    <span class="s2">&quot;Scanner for the regular expression source string.&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">string</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">char_type</span> <span class="o">=</span> <span class="nb">chr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;latin-1&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">char_type</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">c</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_space</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">=</span> <span class="n">string</span><span class="p">[</span> <span class="p">:</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">override_ignore</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">string</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_space</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">override_ignore</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">string</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                        <span class="c1"># Skip over the whitespace.</span>
                        <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">string</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
                        <span class="c1"># Skip over the comment to the end of the line.</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>

            <span class="n">ch</span> <span class="o">=</span> <span class="n">string</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">ch</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="c1"># We&#39;ve reached the end of the string.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span>
            <span class="k">return</span> <span class="n">string</span><span class="p">[</span> <span class="p">:</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># The comment extended to the end of the string.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">string</span><span class="p">[</span> <span class="p">:</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_many</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">string</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_space</span><span class="p">:</span>
                <span class="n">substring</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">substring</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">:</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">string</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                            <span class="c1"># Skip over the whitespace.</span>
                            <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">elif</span> <span class="n">string</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
                            <span class="c1"># Skip over the comment to the end of the line.</span>
                            <span class="n">pos</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">break</span>

                    <span class="n">substring</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
                    <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">substring</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">substring</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">substring</span> <span class="o">=</span> <span class="n">string</span><span class="p">[</span><span class="n">pos</span> <span class="p">:</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">count</span><span class="p">]</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">substring</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span>
            <span class="k">return</span> <span class="n">substring</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="c1"># We&#39;ve reached the end of the string.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">substring</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># The comment extended to the end of the string.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">substring</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_while</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_set</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">keep_spaces</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">string</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_space</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">keep_spaces</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">substring</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">string</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                        <span class="c1"># Skip over the whitespace.</span>
                        <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">string</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
                        <span class="c1"># Skip over the comment to the end of the line.</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="ow">in</span> <span class="n">test_set</span><span class="p">)</span> <span class="o">==</span> <span class="n">include</span><span class="p">:</span>
                        <span class="n">substring</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
                        <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="c1"># We&#39;ve reached the end of the string.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># The comment extended to the end of the string.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>

            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">substring</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="ow">in</span> <span class="n">test_set</span><span class="p">)</span> <span class="o">==</span> <span class="n">include</span><span class="p">:</span>
                    <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">substring</span> <span class="o">=</span> <span class="n">string</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="p">:</span> <span class="n">pos</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span>

                <span class="k">return</span> <span class="n">substring</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="c1"># We&#39;ve reached the end of the string.</span>
                <span class="n">substring</span> <span class="o">=</span> <span class="n">string</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="p">:</span> <span class="n">pos</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span>

                <span class="k">return</span> <span class="n">substring</span>

    <span class="k">def</span> <span class="nf">skip_while</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_set</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">string</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_space</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">string</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                        <span class="c1"># Skip over the whitespace.</span>
                        <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">string</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
                        <span class="c1"># Skip over the comment to the end of the line.</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="ow">in</span> <span class="n">test_set</span><span class="p">)</span> <span class="o">==</span> <span class="n">include</span><span class="p">:</span>
                        <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="ow">in</span> <span class="n">test_set</span><span class="p">)</span> <span class="o">==</span> <span class="n">include</span><span class="p">:</span>
                    <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="c1"># We&#39;ve reached the end of the string.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># The comment extended to the end of the string.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">substring</span><span class="p">):</span>
        <span class="n">string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">string</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_space</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">substring</span><span class="p">:</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">string</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                            <span class="c1"># Skip over the whitespace.</span>
                            <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">elif</span> <span class="n">string</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
                            <span class="c1"># Skip over the comment to the end of the line.</span>
                            <span class="n">pos</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">break</span>

                    <span class="k">if</span> <span class="n">string</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">!=</span> <span class="n">c</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>

                    <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span>

                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="c1"># We&#39;ve reached the end of the string.</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># The comment extended to the end of the string.</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">substring</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">substring</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">expect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">substring</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">substring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;missing </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">substring</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">at_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">string</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_space</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">string</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                        <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">string</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>

            <span class="k">return</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="c1"># We&#39;ve reached the end of the string.</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># The comment extended to the end of the string.</span>
            <span class="k">return</span> <span class="kc">True</span>

<span class="k">class</span> <span class="nc">Info</span><span class="p">:</span>
    <span class="s2">&quot;Info about the regular expression.&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">char_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="n">DEFAULT_FLAGS</span><span class="p">[(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">_ALL_VERSIONS</span><span class="p">)</span> <span class="ow">or</span> <span class="n">DEFAULT_VERSION</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_flags</span> <span class="o">=</span> <span class="n">flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inline_locale</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">group_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_index</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_name</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">char_type</span> <span class="o">=</span> <span class="n">char_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">named_lists_used</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_group_count</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defined_groups</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_calls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">private_groups</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">open_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">group_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_count</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_name</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_count</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">group_index</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">group_name</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_groups</span><span class="p">:</span>
            <span class="c1"># We have a nested named group. We&#39;ll assign it a private group</span>
            <span class="c1"># number, initially negative until we can assign a proper</span>
            <span class="c1"># (positive) number.</span>
            <span class="n">group_alias</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">private_groups</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">private_groups</span><span class="p">[</span><span class="n">group_alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">group_alias</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">open_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_group_count</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_group_count</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">group</span>

    <span class="k">def</span> <span class="nf">close_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_groups</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">is_open_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c1"># In version 1, a group reference can refer to an open group. We&#39;ll</span>
        <span class="c1"># just pretend the group isn&#39;t open.</span>
        <span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">_ALL_VERSIONS</span><span class="p">)</span> <span class="ow">or</span> <span class="n">DEFAULT_VERSION</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="n">VERSION1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">group</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_groups</span>

<span class="k">def</span> <span class="nf">_check_group_features</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">parsed</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks whether the reverse and fuzzy features of the group calls match</span>
<span class="sd">    the groups which they call.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">call_refs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">additional_groups</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">call</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">group_calls</span><span class="p">:</span>
        <span class="c1"># Look up the reference of this group call.</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">call</span><span class="o">.</span><span class="n">group</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">)</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">call_refs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># This group doesn&#39;t have a reference yet, so look up its features.</span>
            <span class="k">if</span> <span class="n">call</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Calling the pattern as a whole.</span>
                <span class="n">rev</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REVERSE</span><span class="p">)</span>
                <span class="n">fuz</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="n">Fuzzy</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="n">fuz</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
                    <span class="c1"># The pattern as a whole doesn&#39;t have the features we want,</span>
                    <span class="c1"># so we&#39;ll need to make a copy of it with the desired</span>
                    <span class="c1"># features.</span>
                    <span class="n">additional_groups</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">CallRef</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">call_refs</span><span class="p">),</span> <span class="n">parsed</span><span class="p">),</span>
                      <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Calling a capture group.</span>
                <span class="n">def_info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">defined_groups</span><span class="p">[</span><span class="n">call</span><span class="o">.</span><span class="n">group</span><span class="p">]</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">def_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">def_info</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="p">]</span> <span class="o">!=</span> <span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">):</span>
                    <span class="c1"># The group doesn&#39;t have the features we want, so we&#39;ll</span>
                    <span class="c1"># need to make a copy of it with the desired features.</span>
                    <span class="n">additional_groups</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">group</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">fuzzy</span><span class="p">))</span>

            <span class="n">ref</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">call_refs</span><span class="p">)</span>
            <span class="n">call_refs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>

        <span class="n">call</span><span class="o">.</span><span class="n">call_ref</span> <span class="o">=</span> <span class="n">ref</span>

    <span class="n">info</span><span class="o">.</span><span class="n">call_refs</span> <span class="o">=</span> <span class="n">call_refs</span>
    <span class="n">info</span><span class="o">.</span><span class="n">additional_groups</span> <span class="o">=</span> <span class="n">additional_groups</span>

<span class="k">def</span> <span class="nf">_get_required_string</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
    <span class="s2">&quot;Gets the required string and related info of a parsed pattern.&quot;</span>

    <span class="n">req_offset</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">get_required_string</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REVERSE</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">required</span><span class="p">:</span>
        <span class="n">required</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">req_offset</span> <span class="o">&gt;=</span> <span class="n">UNLIMITED</span><span class="p">:</span>
            <span class="n">req_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">req_flags</span> <span class="o">=</span> <span class="n">required</span><span class="o">.</span><span class="n">case_flags</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UNICODE</span><span class="p">):</span>
            <span class="n">req_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UNICODE</span>

        <span class="n">req_chars</span> <span class="o">=</span> <span class="n">required</span><span class="o">.</span><span class="n">folded_characters</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">req_offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">req_chars</span> <span class="o">=</span> <span class="p">()</span>
        <span class="n">req_flags</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">req_offset</span><span class="p">,</span> <span class="n">req_chars</span><span class="p">,</span> <span class="n">req_flags</span>

<span class="k">class</span> <span class="nc">Scanner</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lexicon</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lexicon</span> <span class="o">=</span> <span class="n">lexicon</span>

        <span class="c1"># Combine phrases into a compound pattern.</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">phrase</span><span class="p">,</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">lexicon</span><span class="p">:</span>
            <span class="c1"># Parse the regular expression.</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">Info</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">char_type</span><span class="p">)</span>
            <span class="n">source</span><span class="o">.</span><span class="n">ignore_space</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VERBOSE</span><span class="p">)</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">_parse_pattern</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span><span class="o">.</span><span class="n">at_end</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;unbalanced parenthesis&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
                  <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="c1"># We want to forbid capture groups within each phrase.</span>
            <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">remove_captures</span><span class="p">())</span>

        <span class="c1"># Combine all the subpatterns into one pattern.</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">Info</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">Group</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">g</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">patterns</span><span class="p">)]</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">Branch</span><span class="p">(</span><span class="n">patterns</span><span class="p">)</span>

        <span class="c1"># Optimise the compound pattern.</span>
        <span class="n">reverse</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REVERSE</span><span class="p">)</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">optimise</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">pack_characters</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

        <span class="c1"># Get the required string.</span>
        <span class="n">req_offset</span><span class="p">,</span> <span class="n">req_chars</span><span class="p">,</span> <span class="n">req_flags</span> <span class="o">=</span> <span class="n">_get_required_string</span><span class="p">(</span><span class="n">parsed</span><span class="p">,</span>
          <span class="n">info</span><span class="o">.</span><span class="n">flags</span><span class="p">)</span>

        <span class="c1"># Check the features of the groups.</span>
        <span class="n">_check_group_features</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">parsed</span><span class="p">)</span>

        <span class="c1"># Complain if there are any group calls. They are not supported by the</span>
        <span class="c1"># Scanner class.</span>
        <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">call_refs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s2">&quot;recursive regex not supported by Scanner&quot;</span><span class="p">,</span>
              <span class="n">source</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">reverse</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">REVERSE</span><span class="p">)</span>

        <span class="c1"># Compile the compound pattern. The result is a list of tuples.</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">reverse</span><span class="p">)</span> <span class="o">+</span> <span class="p">[(</span><span class="n">OP</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span> <span class="p">)]</span>

        <span class="c1"># Flatten the code into a list of ints.</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">_flatten_code</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">parsed</span><span class="o">.</span><span class="n">has_simple_start</span><span class="p">():</span>
            <span class="c1"># Get the first set, if possible.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fs_code</span> <span class="o">=</span> <span class="n">_compile_firstset</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">parsed</span><span class="o">.</span><span class="n">get_firstset</span><span class="p">(</span><span class="n">reverse</span><span class="p">))</span>
                <span class="n">fs_code</span> <span class="o">=</span> <span class="n">_flatten_code</span><span class="p">(</span><span class="n">fs_code</span><span class="p">)</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">fs_code</span> <span class="o">+</span> <span class="n">code</span>
            <span class="k">except</span> <span class="n">_FirstSetError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Check the global flags for conflicts.</span>
        <span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">_ALL_VERSIONS</span><span class="p">)</span> <span class="ow">or</span> <span class="n">DEFAULT_VERSION</span>
        <span class="k">if</span> <span class="n">version</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">VERSION0</span><span class="p">,</span> <span class="n">VERSION1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;VERSION0 and VERSION1 flags are mutually incompatible&quot;</span><span class="p">)</span>

        <span class="c1"># Create the PatternObject.</span>
        <span class="c1">#</span>
        <span class="c1"># Local flags like IGNORECASE affect the code generation, but aren&#39;t</span>
        <span class="c1"># needed by the PatternObject itself. Conversely, global flags like</span>
        <span class="c1"># LOCALE _don&#39;t_ affect the code generation but _are_ needed by the</span>
        <span class="c1"># PatternObject.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scanner</span> <span class="o">=</span> <span class="n">_regex</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GLOBAL_FLAGS</span><span class="p">)</span> <span class="o">|</span> <span class="n">version</span><span class="p">,</span>
          <span class="n">code</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">[],</span> <span class="n">req_offset</span><span class="p">,</span> <span class="n">req_chars</span><span class="p">,</span> <span class="n">req_flags</span><span class="p">,</span>
          <span class="nb">len</span><span class="p">(</span><span class="n">patterns</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">append</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span>
        <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanner</span><span class="o">.</span><span class="n">scanner</span><span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="o">.</span><span class="n">match</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">match</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lexicon</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">lastindex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="s1">&#39;__call__&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">m</span>
                <span class="n">action</span> <span class="o">=</span> <span class="n">action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">j</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">string</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="p">]</span>

<span class="c1"># Get the known properties dict.</span>
<span class="n">PROPERTIES</span> <span class="o">=</span> <span class="n">_regex</span><span class="o">.</span><span class="n">get_properties</span><span class="p">()</span>

<span class="c1"># Build the inverse of the properties dict.</span>
<span class="n">PROPERTY_NAMES</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">prop_name</span><span class="p">,</span> <span class="p">(</span><span class="n">prop_id</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="ow">in</span> <span class="n">PROPERTIES</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">prop_values</span> <span class="o">=</span> <span class="n">PROPERTY_NAMES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prop_id</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">{}))</span>
    <span class="n">name</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">prop_name</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">)</span>
    <span class="n">PROPERTY_NAMES</span><span class="p">[</span><span class="n">prop_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span> <span class="n">prop_values</span>

    <span class="k">for</span> <span class="n">val_name</span><span class="p">,</span> <span class="n">val_id</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">prop_values</span><span class="p">[</span><span class="n">val_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">prop_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">val_id</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="n">val_name</span><span class="p">,</span>
          <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">)</span>

<span class="c1"># Character escape sequences.</span>
<span class="n">CHARACTER_ESCAPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\a</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\b</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;f&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\f</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;t&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;v&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\v</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Predefined character set escape sequences.</span>
<span class="n">CHARSET_ESCAPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;d&quot;</span><span class="p">:</span> <span class="n">lookup_property</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Digit&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
    <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="n">lookup_property</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Digit&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
    <span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="n">lookup_property</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Blank&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
    <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="n">lookup_property</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Space&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
    <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">lookup_property</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Space&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
    <span class="s2">&quot;w&quot;</span><span class="p">:</span> <span class="n">lookup_property</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Word&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
    <span class="s2">&quot;W&quot;</span><span class="p">:</span> <span class="n">lookup_property</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Word&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
<span class="p">}</span>

<span class="c1"># Positional escape sequences.</span>
<span class="n">POSITION_ESCAPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="n">StartOfString</span><span class="p">(),</span>
    <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="n">Boundary</span><span class="p">(),</span>
    <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="n">Boundary</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span>
    <span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="n">Keep</span><span class="p">(),</span>
    <span class="s2">&quot;m&quot;</span><span class="p">:</span> <span class="n">StartOfWord</span><span class="p">(),</span>
    <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="n">EndOfWord</span><span class="p">(),</span>
    <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="n">EndOfString</span><span class="p">(),</span>
<span class="p">}</span>

<span class="c1"># Positional escape sequences when WORD flag set.</span>
<span class="n">WORD_POSITION_ESCAPES</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">POSITION_ESCAPES</span><span class="p">)</span>
<span class="n">WORD_POSITION_ESCAPES</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="n">DefaultBoundary</span><span class="p">(),</span>
    <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="n">DefaultBoundary</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span>
    <span class="s2">&quot;m&quot;</span><span class="p">:</span> <span class="n">DefaultStartOfWord</span><span class="p">(),</span>
    <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="n">DefaultEndOfWord</span><span class="p">(),</span>
<span class="p">})</span>

<span class="c1"># Regex control verbs.</span>
<span class="n">VERBS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;FAIL&quot;</span><span class="p">:</span> <span class="n">Failure</span><span class="p">(),</span>
    <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="n">Failure</span><span class="p">(),</span>
    <span class="s2">&quot;PRUNE&quot;</span><span class="p">:</span> <span class="n">Prune</span><span class="p">(),</span>
    <span class="s2">&quot;SKIP&quot;</span><span class="p">:</span> <span class="n">Skip</span><span class="p">(),</span>
<span class="p">}</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Andreas van Cranenburgh.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>